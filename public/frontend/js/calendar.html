<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=5.0">
    <title>Khojum | Event List & Calendar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Enhanced Variables --- */
        :root {
            --font-primary: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --font-nepali: 'Noto Sans Devanagari', var(--font-primary);
            --c-primary: #6D5B97;
            --c-secondary: #A0D2DB;
            --c-accent: #F5A6E8;
            --c-text-dark: #34495e;
            --c-text-light: #7f8c8d;
            --c-bg-main: #f8f9fd;
            --c-bg-panel: #ffffff;
            --c-border: #e2e8f0;
            --c-today-bg: color-mix(in srgb, var(--c-primary) 20%, transparent);
            --c-today-text: var(--c-primary);
            --c-selected-border: var(--c-primary);
            --c-selected-bg: color-mix(in srgb, var(--c-secondary) 15%, transparent);
            --c-holiday-text: #27ae60;
            --c-event-dot-size: 5px; /* Slightly smaller dots */
            --c-mobile-event-dot-size: 4px;
            --c-highlight-bg: #fff3cd;
            --shadow-light: 0 2px 5px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.08);
            --shadow-heavy: 0 10px 30px rgba(0, 0, 0, 0.12);
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s ease;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-primary); margin: 0; background-color: var(--c-bg-main);
            color: var(--c-text-dark); line-height: 1.6; font-size: 15px;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        button { cursor: pointer; border: none; background: none; padding: 0; font-family: inherit; color: inherit; font-weight: 500; }
        ul { list-style: none; padding: 0; margin: 0; }
        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 600; }
        a { color: var(--c-primary); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }

        /* Highlight for Deep Linking */
        .highlight { animation: highlight-fade 2.5s ease-in-out; /* Slightly longer */ }
        @keyframes highlight-fade {
            0%, 100% { background-color: transparent; }
            10%, 70% { background-color: var(--c-highlight-bg); } /* Hold highlight longer */
        }

        /* Page Header / Controls */
        .page-controls { background-color: var(--c-bg-panel); padding: 15px; border-radius: 12px; box-shadow: var(--shadow-medium); margin-bottom: 25px; }
        .controls-top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .view-switcher { display: flex; gap: 10px; border-bottom: 1px solid var(--c-border); flex-grow: 1; }
        .view-tab { padding: 10px 15px; font-weight: 500; color: var(--c-text-light); position: relative; border-bottom: 3px solid transparent; transition: color var(--transition-fast), border-color var(--transition-fast); }
        .view-tab:hover { color: var(--c-primary); }
        .view-tab.active { color: var(--c-primary); border-bottom-color: var(--c-primary); }
        .global-actions a { /* Promote link */
            background-color: var(--c-primary); color: white !important; padding: 9px 20px; border-radius: 20px; font-size: 0.9em; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; box-shadow: var(--shadow-light); text-decoration: none !important; transition: background-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast); white-space: nowrap;
        }
        .global-actions a:hover { background-color: color-mix(in srgb, var(--c-primary) 85%, black); transform: translateY(-2px); box-shadow: var(--shadow-medium); }

        /* Category Filters (Shared) */
        #event-categories-filter { display: flex; flex-wrap: nowrap; gap: 8px; padding: 10px 0; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: var(--c-border) transparent; }
        #event-categories-filter::-webkit-scrollbar { height: 4px; }
        #event-categories-filter::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 2px; }
        .category-filter { display: flex; align-items: center; cursor: pointer; padding: 6px 14px; border-radius: 18px; background-color: #f0f3f7; font-size: 0.85em; transition: all var(--transition-fast); white-space: nowrap; border: 1px solid transparent; }
        .category-filter:hover { background-color: #e8eaf0; }
        .category-filter.selected { background-color: color-mix(in srgb, var(--c-primary) 15%, transparent); color: var(--c-primary); font-weight: 600; border-color: color-mix(in srgb, var(--c-primary) 30%, transparent); box-shadow: var(--shadow-light); }
        .category-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 7px; flex-shrink: 0; }
        .category-name { color: var(--c-text-dark); }
        .category-filter.selected .category-name { color: var(--c-primary); }

        /* View Containers */
        .view-container { display: none; }
        .view-container.active { display: block; animation: fadeInView 0.5s ease-out; }
        @keyframes fadeInView { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* List View Styles */
        #list-view-container { /* Container has less styling now */ padding: 0; background: none; box-shadow: none; border-radius: 0; }
        .list-date-group { margin-bottom: 35px; }
        .list-date-header {
            font-size: 1.4em; font-weight: 700; /* Bolder */ color: var(--c-primary);
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--c-primary); /* Primary color border */
            display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap;
        }
        .list-date-header .sub-date { font-size: 0.7em; color: var(--c-text-light); font-weight: 500; } /* Slightly bolder */

        .event-item { position: relative; }
        .event-item:not(:last-child) { margin-bottom: 18px; } /* More space between cards */

        .event-card {
            background-color: var(--c-bg-panel); padding: 0; /* Remove padding here, apply to inner divs */ border-radius: 10px; /* More rounded */
            border: 1px solid var(--c-border);
            /* border-left: none; Remove default colored border */
            transition: all var(--transition-medium); /* Slower transition */
            display: flex; /* Use flex for image/content layout */
            box-shadow: var(--shadow-medium); cursor: pointer;
            overflow: hidden; /* Ensure children don't overflow rounded corners */
        }
        .event-card:hover { box-shadow: var(--shadow-heavy); transform: scale(1.015); /* Slightly scale up */ border-color: color-mix(in srgb, var(--c-primary) 30%, transparent); }

        /* NEW: Image container */
        .event-image-container {
            flex-shrink: 0;
            width: 120px; /* Fixed width for image */
            height: auto; /* Let height adjust */
            background-color: #eee; /* Placeholder bg */
            position: relative;
        }
        .event-image-container img {
            display: block;
            width: 100%;
            height: 100%; /* Fill container height */
            object-fit: cover; /* Cover the area, might crop */
            aspect-ratio: 3 / 4; /* Portrait aspect ratio */
            border-radius: 10px 0 0 10px; /* Round left corners */
        }
        /* Style adjustments when no image */
        .event-card:not(.has-image) .event-image-container { display: none; }
        .event-card:not(.has-image) .event-content-wrapper { padding: 18px 20px; /* Add padding back if no image */ }
        .event-card:not(.has-image) { padding: 0; } /* Reset card padding */

        .event-content-wrapper {
            flex-grow: 1; padding: 18px 20px; /* Padding moved here */
            overflow: hidden; display: flex; flex-direction: column; /* Stack content vertically */
        }
        .event-header { display: flex; align-items: flex-start; margin-bottom: 8px; } /* Align items top */
        .event-icon { margin-right: 9px; font-size: 1.1em; color: var(--c-primary); margin-top: 2px; flex-shrink: 0;}
        .event-name { font-weight: 700; color: var(--c-text-dark); font-size: 1.1em; line-height: 1.3; margin-bottom: 4px; /* Space below name */ }
        .event-details { font-size: 0.9em; color: var(--c-text-dark); display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; font-weight: 400; } /* Stack details */
        .event-time, .event-location { display: inline-flex; align-items: center; gap: 6px; }
        .event-time::before, .event-location::before { font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 0.9em; color: var(--c-text-light); width: 14px; text-align: center; }
        .event-time::before { content: "\f017"; }
        .event-location::before { content: "\f3c5"; }
        .event-description { font-size: 0.9em; margin-top: auto; /* Push description down */ color: var(--c-text-dark); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; padding-top: 10px; border-top: 1px dashed var(--c-border); font-weight: 400; }
        .event-card:not(.has-description) .event-description { display: none; } /* Hide if no description */


        .no-events-list { padding: 50px 20px; text-align: center; color: var(--c-text-light); font-style: normal; font-size: 1em; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; min-height: 250px; background-color: var(--c-bg-panel); border-radius: 12px; box-shadow: var(--shadow-light); }
        .no-events-list::before { content: "\f11a"; font-family: 'Font Awesome 6 Free'; font-weight: 400; font-size: 3em; color: var(--c-border); }

        /* --- Calendar View Styles (Keep as is, layout handled by media query) --- */
        #calendar-view-container { background-color: var(--c-bg-panel); border-radius: 12px; box-shadow: var(--shadow-light); overflow: hidden; display: flex; flex-direction: column; }
        /* ... (Keep all other specific Calendar styles: .calendar-main, .calendar-header, .nav-button, #month-year, .calendar-config, .toggle-switch, .calendar-weekdays, .weekday, .calendar-days, .day, .day-dates, .eng-date, .nepali-date, .day.inactive, .day.today, .day.selected, .day.holiday, .event-indicator, .event-dot, .event-count, #events-panel, .event-panel-header, #event-panel-date, .holiday-badge, .event-panel-list, .no-events) ... */
         .calendar-main { flex-shrink: 1; display: flex; flex-direction: column; border-bottom: 1px solid var(--c-border); }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid var(--c-border); background-color: var(--c-bg-panel); flex-shrink: 0; }
        #month-year { font-size: 1.15em; font-weight: 600; color: var(--c-primary); text-align: center; flex-grow: 1; margin: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-button { color: var(--c-text-light); font-size: 1.2em; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; transition: background-color var(--transition-fast), color var(--transition-fast); flex-shrink: 0; }
        .nav-button:hover { background-color: #f0f0f0; color: var(--c-primary); }
        .nav-button.close-button:hover { background-color: #fde0e0; color: var(--c-danger); } /* Keep for modal close */
        .calendar-config { display: flex; justify-content: flex-end; align-items: center; padding: 8px 15px; border-bottom: 1px solid var(--c-border); background-color: #fafbff; font-size: 0.8em; flex-shrink: 0; }
        .toggle-switch { display: flex; align-items: center; cursor: pointer; color: var(--c-text-light); }
        .toggle-switch span { margin-right: 8px;}
        .toggle-switch input { display: none; }
        .toggle-switch .slider { width: 40px; height: 20px; background-color: #ccc; border-radius: 20px; position: relative; transition: background-color var(--transition-medium); }
        .toggle-switch .slider::before { content: ""; position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: transform var(--transition-medium); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .toggle-switch input:checked + .slider { background-color: var(--c-primary); }
        .toggle-switch input:checked + .slider::before { transform: translateX(20px); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); padding: 8px 5px; background-color: #fafbff; border-bottom: 1px solid var(--c-border); flex-shrink: 0; }
        .weekday { text-align: center; font-weight: 600; font-size: 0.75em; color: var(--c-text-light); text-transform: uppercase; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: var(--c-border); flex-grow: 1; padding: 1px; transition: opacity 0.2s ease-out; min-height: 400px; }
        .calendar-days.fade-out { opacity: 0; }
        .calendar-days.fade-in { animation: fadeInGrid 0.3s ease-out; }
        @keyframes fadeInGrid { from { opacity: 0; } to { opacity: 1; } }
        .day { background-color: var(--c-bg-panel); padding: 5px; box-sizing: border-box; text-align: right; position: relative; min-height: 70px; cursor: pointer; transition: background-color var(--transition-fast); display: flex; flex-direction: column; font-size: 0.8em; overflow: hidden; }
        .day:hover:not(.inactive) { background-color: color-mix(in srgb, var(--c-secondary) 10%, transparent); }
        .day.inactive { background-color: var(--c-bg-main); color: #bbb; cursor: default; }
        .day-dates { line-height: 1.3; margin-bottom: auto; position: relative; height: 2.6em; }
        .eng-date, .nepali-date { display: block; position: absolute; right: 0; width: 100%; transition: transform var(--transition-medium), opacity var(--transition-medium); font-family: var(--font-primary); }
        .eng-date { top: 0; font-size: 1.1em; font-weight: 500; color: var(--c-text-dark); transform: translateY(0); opacity: 1; }
        .nepali-date { top: 1.3em; font-size: 0.85em; color: var(--c-text-light); font-family: var(--font-nepali); transform: translateY(0); opacity: 1; }
        .calendar-days.nepali-visible .eng-date { transform: translateY(-5px); opacity: 0; }
        .calendar-days.nepali-visible .nepali-date { transform: translateY(-1.3em); opacity: 1; font-size: 1.1em; font-weight: 500; color: var(--c-text-dark); }
        .calendar-days:not(.nepali-visible) .eng-date { transform: translateY(0); opacity: 1; }
        .calendar-days:not(.nepali-visible) .nepali-date { transform: translateY(5px); opacity: 0; }
        .day.inactive .eng-date, .day.inactive .nepali-date { color: #ccc; }
        .day.today { background-color: var(--c-today-bg); border-radius: 4px; }
        .day.today .eng-date, .day.today .nepali-date { color: var(--c-today-text); font-weight: 700; }
        .calendar-days.nepali-visible .day.today .nepali-date { color: var(--c-today-text); }
        .calendar-days.nepali-visible .day.today .eng-date { color: color-mix(in srgb, var(--c-today-text) 60%, transparent); font-weight: 500; }
        .day.selected { background-color: var(--c-selected-bg); box-shadow: inset 0 0 0 2px var(--c-selected-border); border-radius: 4px; }
        .day.holiday .eng-date, .calendar-days.nepali-visible .day.holiday .nepali-date { color: var(--c-holiday-text) !important; font-weight: 600; }
        .day.holiday::after { content: ''; position: absolute; bottom: 2px; left: 5px; right: 5px; height: 2px; background-color: var(--c-holiday-text); border-radius: 1px; opacity: 0.6; }
        .event-indicator { display: flex; flex-wrap: wrap; gap: 3px; justify-content: flex-start; margin-top: 4px; max-height: 18px; overflow: hidden; padding-left: 2px; }
        .event-dot { width: var(--c-mobile-event-dot-size); height: var(--c-mobile-event-dot-size); border-radius: 50%; flex-shrink: 0; }
        .event-count { font-size: 0.7em; font-weight: bold; color: var(--c-text-light); margin-left: 3px; background: rgba(0,0,0,0.04); padding: 0 4px; border-radius: 4px; line-height: 1.2; align-self: center; }
        #events-panel { width: 100%; height: auto; background-color: var(--c-bg-panel); display: flex; flex-direction: column; border-radius: 0; overflow: hidden; }
        .event-panel-header { padding: 12px 15px; border-bottom: 1px solid var(--c-border); flex-shrink: 0; position: relative; background-color: #fafbff; }
        #event-panel-date { font-weight: 600; font-size: 1.1em; margin-bottom: 2px; color: var(--c-primary); }
        #event-panel-date .sub-date { font-size: 0.8em; color: var(--c-text-light); display: block; }
        .holiday-badge { display: inline-block; background-color: var(--c-holiday-text); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 500; margin-top: 5px; }
        .event-panel-list { flex-grow: 1; overflow-y: auto; padding: 15px; min-height: 150px; }
        .no-events { padding: 40px 15px; text-align: center; color: var(--c-text-light); font-style: normal; font-size: 0.9em; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; height: 100%; }
        .no-events::before { content: "\f11a"; font-family: 'Font Awesome 6 Free'; font-weight: 400; font-size: 2.5em; color: var(--c-border); }


        /* Event Details Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1050; opacity: 0; visibility: hidden; transition: opacity var(--transition-medium), visibility 0s var(--transition-medium); }
        .modal-overlay.active { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content { background-color: var(--c-bg-panel); padding: 0; /* Remove padding */ border-radius: 12px; box-shadow: var(--shadow-heavy); width: 90%; max-width: 600px; /* Wider modal */ position: relative; transform: scale(0.95); transition: transform var(--transition-medium); max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; /* Ensure rounded corners clip content */ }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; /* Adjusted padding */ border-bottom: 1px solid var(--c-border); flex-shrink: 0;}
        .modal-title { font-size: 1.3em; color: var(--c-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 15px; }
        .modal-close-button { flex-shrink: 0; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding: 20px 25px; /* Padding for content */ }
        /* NEW: Modal Image */
        .detail-image-container {
            width: 100%;
            margin-bottom: 20px;
            background-color: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
        }
         .detail-image-container img {
             display: block;
             width: 100%;
             height: auto;
             max-height: 300px; /* Limit image height */
             object-fit: cover;
         }
        .detail-item { margin-bottom: 14px; display: flex; align-items: flex-start; gap: 12px; font-size: 1em; } /* Slightly larger font */
        .detail-item i.fas { color: var(--c-primary); width: 22px; text-align: center; margin-top: 4px; flex-shrink: 0; font-size: 1.1em;}
        .detail-item span { color: var(--c-text-dark); line-height: 1.5; }
        #detail-category { font-weight: 500; }
        #detail-description-item h4 { font-size: 1.1em; color: var(--c-text-dark); margin-bottom: 8px; margin-top: 10px; }
        .detail-description { white-space: pre-wrap; line-height: 1.6; background-color: var(--c-bg-main); padding: 12px 15px; border-radius: 6px; font-size: 0.95em; color: #444; }
        .modal-footer { margin-top: 20px; padding: 15px 25px; /* Add padding */ border-top: 1px solid var(--c-border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; flex-wrap: wrap; gap: 10px; background-color: #fafbff; /* Light footer bg */ }
        .modal-share-buttons { display: flex; gap: 12px; }
        .modal-button.share { background-color: #e9edf1; padding: 9px 15px; font-size: 0.9em; border-radius: 6px; display: inline-flex; align-items: center; gap: 7px; transition: background-color var(--transition-fast), color var(--transition-fast); border: 1px solid var(--c-border); }
        .modal-button.share i { font-size: 1.2em; }
        .modal-button.share:hover { background-color: #dde3ea; }
        .modal-button.share.whatsapp { color: #25D366; border-color: #ace9c0; }
        .modal-button.share.whatsapp:hover { background-color: #e0f5e6; }
        .modal-button.share.copy { color: var(--c-primary); border-color: color-mix(in srgb, var(--c-primary) 40%, transparent); }
        .modal-button.share.copy:hover { background-color: color-mix(in srgb, var(--c-primary) 10%, transparent); }

        /* Toast Notification */
        #toast-notification { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 12px 22px; border-radius: 25px; font-size: 0.95rem; z-index: 1100; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; transform: translate(-50%, 10px); }
        #toast-notification.show { opacity: 1; transform: translate(-50%, 0); }

        /* Desktop / Larger Screens */
        @media (min-width: 768px) {
            body { font-size: 16px; }
            .event-image-container { width: 180px; height: auto; } /* Wider image on desktop */
            .event-card:not(.has-image) .event-content-wrapper { padding: 20px 25px; }
            .event-content-wrapper { padding: 20px 25px; }
            .event-name { font-size: 1.2em; }
            .event-details { font-size: 0.95em; flex-direction: row; gap: 20px; } /* Side-by-side details */
            .event-description { -webkit-line-clamp: 3; } /* Allow more description lines */
            /* Calendar View Desktop Layout */
            #calendar-view-container { flex-direction: row; max-height: 80vh; }
             .calendar-main { flex-grow: 1; flex-shrink: 1; height: 100%; min-height: auto; border-right: 1px solid var(--c-border); border-bottom: none; overflow: visible; border-radius: 12px 0 0 12px; }
             .calendar-header { border-radius: 12px 0 0 0; padding: 15px 20px; }
             #month-year { font-size: 1.3em; }
             .nav-button { font-size: 1.3em; }
             .calendar-config { padding: 10px 20px; font-size: 0.9em; }
             .calendar-weekdays { padding: 10px 5px; }
             .weekday { font-size: 0.8em; }
             .calendar-days { overflow-y: hidden; min-height: 550px; } /* Taller grid */
             .day { min-height: 100px; padding: 8px; font-size: 0.85em; } /* Taller cells */
             .day-dates { height: 3em; }
             .eng-date { font-size: 1.2em; top: 0; }
             .nepali-date { font-size: 0.9em; top: 1.5em; }
             .calendar-days.nepali-visible .nepali-date { transform: translateY(-1.5em); font-size: 1.2em; }
             .event-dot { width: var(--c-event-dot-size); height: var(--c-event-dot-size); }
             .event-indicator { max-height: 22px; }
             #events-panel { width: 360px; flex-shrink: 0; height: 100%; border-left: 1px solid var(--c-border); box-shadow: none; border-radius: 0 12px 12px 0; overflow-y: hidden; display: flex; flex-direction: column; }
             .event-panel-header { padding: 18px 25px; border-radius: 0 12px 0 0; }
             #event-panel-date { font-size: 1.2em; }
             #event-panel-date .sub-date { font-size: 0.85em; }
             .holiday-badge { font-size: 0.75em; padding: 3px 10px; }
             .event-panel-list { padding: 20px 25px; flex-grow: 1; overflow-y: auto; }
             /* Event Card styles inside panel are inherited */
             .no-events { padding: 50px 20px; font-size: 1em; }
             .no-events::before { font-size: 3em; }
             /* Modal */
             .modal-content { max-width: 700px; }
             .modal-title { font-size: 1.5em; }
             .detail-image-container { max-height: 350px; }
        }
         @media (max-width: 480px) {
            /* Fine-tune mobile card */
             .event-image-container { width: 100px; }
             .event-content-wrapper { padding: 15px; }
             .event-name { font-size: 1em; }
             .event-details { font-size: 0.8em; gap: 4px;}
             .event-description { font-size: 0.85em; -webkit-line-clamp: 2;}
         }

    </style>
</head>
<body>

    <div class="container">
        <h1>Daily money saving deals..</h1>
        <div class="page-controls">
            <div class="controls-top-row">
                 <div class="view-switcher">
                    
                    <button class="view-tab" data-view="calendar">📅  Calendar View</button>
                     <button class="view-tab active" data-view="list"> ☰List View</button>
                     
                 </div>
                 <div class="global-actions">
                     <a href="/promote.html" class="add-event-btn-global">
                         <i class="fas fa-bullhorn"></i> List your products here
                     </a>
                 </div>
            </div>
            <div id="event-categories-filter">
                <!-- Shared Category filters generated here -->
            </div>
        </div>


        <div id="calendar-view-container" class="view-container active">
            <!-- Calendar DOM injected here by JS when activated -->
        </div>

        <!-- List View Container -->
        <div id="list-view-container" class="view-container">
            <!-- List content generated by JS -->
        </div>

        <!-- Calendar View Container (Initially Empty) -->
        
    </div> <!-- End Container -->


    <!-- Event Details Modal -->
    <div id="event-details-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="event-detail-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="event-detail-title" class="modal-title">Event Details</h3>
                <button id="close-detail-modal-button" class="nav-button close-button modal-close-button" aria-label="Close Event Details">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="event-detail-body">
                 <!-- Image container -->
                 <div class="detail-image-container" id="detail-image-wrapper">
                     <img src="#" alt="Event Image" id="detail-image">
                 </div>
                 <!-- Details -->
                 <div class="detail-item">
                    <i class="fas fa-calendar-day"></i> <span id="detail-date">Date</span>
                 </div>
                 <div class="detail-item" id="detail-time-item">
                    <i class="fas fa-clock"></i> <span id="detail-time">Time</span>
                 </div>
                 <div class="detail-item" id="detail-location-item">
                    <i class="fas fa-map-marker-alt"></i> <span id="detail-location">Location</span>
                 </div>
                 <div class="detail-item" id="detail-category-item">
                    <i class="fas fa-tag"></i> <span id="detail-category">Category</span>
                 </div>
                 <div id="detail-description-item">
                    <h4>Description</h4>
                    <p id="detail-description" class="detail-description">Description</p>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-share-buttons">
                     <button class="modal-button share whatsapp" id="detail-share-whatsapp" title="Share on WhatsApp">
                         <i class="fab fa-whatsapp"></i> WhatsApp
                     </button>
                     <button class="modal-button share copy" id="detail-share-copy" title="Copy Link">
                         <i class="fas fa-link"></i> Copy Link
                     </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification">Copied!</div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Khojum V3 script loaded.");

            // --- DOM Elements ---
            const viewTabs = document.querySelectorAll('.view-tab');
            const viewContainers = document.querySelectorAll('.view-container');
            const listViewContainer = document.getElementById('list-view-container');
            const calendarViewContainer = document.getElementById('calendar-view-container');
            // Calendar elements (initialized later)
            let prevMonthBtn, nextMonthBtn, monthYearDisplay, calendarDaysContainer, nepaliDateToggle, eventsPanel, eventPanelDate, eventPanelList;
            // Shared / Global
            const eventCategoriesFilter = document.getElementById('event-categories-filter');
            // Details Modal elements
            const eventDetailsModal = document.getElementById('event-details-modal');
            const closeDetailModalBtn = document.getElementById('close-detail-modal-button');
            const eventDetailTitle = document.getElementById('event-detail-title');
            // const eventDetailBody = document.getElementById('event-detail-body'); // Not needed directly?
            const detailImageWrapper = document.getElementById('detail-image-wrapper');
            const detailImage = document.getElementById('detail-image');
            const detailDate = document.getElementById('detail-date');
            const detailTime = document.getElementById('detail-time');
            const detailLocation = document.getElementById('detail-location');
            const detailCategory = document.getElementById('detail-category');
            const detailDescription = document.getElementById('detail-description');
            const detailTimeItem = document.getElementById('detail-time-item');
            const detailLocationItem = document.getElementById('detail-location-item');
            const detailCategoryItem = document.getElementById('detail-category-item');
            const detailDescriptionItem = document.getElementById('detail-description-item');
            const detailShareWhatsapp = document.getElementById('detail-share-whatsapp');
            const detailShareCopy = document.getElementById('detail-share-copy');
            const toast = document.getElementById('toast-notification');

            // --- State ---
            let currentView = 'list';
            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();
            let showNepaliDates = false;
            let selectedDate = null; // Date object for Calendar selection
            let selectedCategories = new Set();
            let isMobileView = window.innerWidth < 768;
            let calendarRendered = false; // Lazy load flag
            let eventsById = new Map(); // For lookup

             // --- Data & Config ---
             const eventsData = { // Added imageUrl examples
                 '2024-07-15': [ { id: 'evt1', name: 'Team Lunch at Bytes Cafe', category: 'work', time: '12:30', location: 'Bytes Cafe', description: 'Celebrate project milestone. Discuss Q3 roadmap informally.', imageUrl: 'https://via.placeholder.com/300x400/A0D2DB/34495e?text=Team+Lunch' } ],
                 '2024-07-22': [ { id: 'evt3', name: 'Impressionist Art Workshop', category: 'culture', time: '10:00 - 13:00', location: 'City Art Gallery', description: 'Learn painting techniques inspired by Monet and Renoir. Materials provided.', imageUrl: 'https://via.placeholder.com/300x400/9370db/ffffff?text=Art+Workshop' } ],
                 '2024-07-05': [ { id: 'evt4', name: 'Mega Summer Sale', category: 'promotion', time: 'All Day', location: 'Downtown Mall', description: 'Up to 50% off on selected fashion, electronics, and home goods. Don\'t miss out!', imageUrl: 'https://via.placeholder.com/300x400/f1c40f/34495e?text=SALE' } ],
                 '2024-08-01': [
                    { id: 'evt5', name: 'Lakeside Music Festival', category: 'holiday', time: '12:00 onwards', location: 'Green Valley Park', description: 'Live bands, food trucks, and family activities by the lake.', imageUrl: 'https://via.placeholder.com/300x400/2ecc71/ffffff?text=Festival' },
                    { id: 'evt6', name: 'Intro to Web Development Bootcamp', category: 'education', time: '14:00 - 17:00', location: 'Tech Hub Co-working', description: 'Get started with HTML, CSS, and JavaScript basics. Bring your laptop!', imageUrl: 'https://via.placeholder.com/300x400/4682b4/ffffff?text=Code+Camp' },
                    { id: 'evt7', name: 'Acoustic Open Mic Night', category: 'entertainment', time: '20:00', location: 'The Corner Brew', description: 'Share your songs, poetry, or just enjoy the local talent.' } // No image example
                 ],
                 [(new Date().toISOString().split('T')[0])] : [
                    { id: 'evt101', name: 'Project Phoenix Standup', category: 'work', time: '09:00', location: 'Office / Zoom', description: 'Quick updates on blockers and progress.' },
                    { id: 'evt103', name: 'Evening Yoga Flow', category: 'health', time: '18:00', location: 'Studio B', description: 'Relax and rejuvenate.', imageUrl: 'https://via.placeholder.com/300x400/1abc9c/ffffff?text=Yoga' }
                 ],
                 [(() => { const d = new Date(); d.setDate(d.getDate() + 1); return d.toISOString().split('T')[0]; })()] : [
                    { id: 'evt102', name: 'Client Presentation - Final Review', category: 'meeting', time: '11:00', location: 'Meeting Room 3', description: 'Go through slides and talking points for tomorrow\'s client meeting.' }
                 ],
                  '2024-08-10': [ { id: 'evt201', name: 'Mountain Hiking Trip', category: 'personal', time: 'All Day', location: 'Eagle Peak Trail', description: 'Weekend hiking getaway. Pack essentials.', imageUrl: 'https://via.placeholder.com/300x400/e74c3c/ffffff?text=Hiking' }],
                  '2024-08-11': [ { id: 'evt202', name: 'Return from Hiking Trip', category: 'personal', time: 'Afternoon', location: 'Eagle Peak Trail', description: 'Drive back home.' }],
             };
             const holidays = { /* ... keep data ... */
                  nepali: { '2081-01-01': 'Nepali New Year', '2081-07-03': 'Dashain (Phulpati)', '2081-07-21': 'Tihar (Laxmi Puja)', },
                english: { '2024-01-01': 'New Year\'s Day', '2024-12-25': 'Christmas Day', '2024-07-04': 'Independence Day (US)' }
             };
             const categoryConfig = { /* ... keep data ... */
                 'entertainment': { color: '#ff7f50', icon: '🎵' }, 'education': { color: '#4682b4', icon: '📚' },
                'culture': { color: '#9370db', icon: '🎨' }, 'holiday': { color: '#2ecc71', icon: '🎉' }, // Brighter green
                'promotion': { color: '#f1c40f', icon: '💰' }, 'work': { color: '#3498db', icon: '💼' }, // Brighter blue
                'health': { color: '#1abc9c', icon: '❤️' }, 'personal': { color: '#e74c3c', icon: '👤' }, // Red for personal
                'meeting': { color: '#8e44ad', icon: '🗣️' },
                'default': { color: '#95a5a6', icon: '📅' } // Grey
             };
             const nepaliDaysInMonth = { /* ... keep data ... */
                 2080: [30, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30], 2081: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 29, 30],
                2082: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2083: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 30],
             };
             const nepaliMonths = [ /* ... keep data ... */ 'बैशाख', 'जेठ', 'असार', 'श्रावण', 'भदौ', 'असोज', 'कार्तिक', 'मंसिर', 'पुष', 'माघ', 'फागुन', 'चैत' ];
             const nepaliDigits = [/* ... keep data ... */ '०', '१', '२', '३', '४', '५', '६', '७', '८', '९'];

            // --- Helper Functions ---
             function toNepaliDigits(num) { return num.toString().split('').map(d => nepaliDigits[parseInt(d)] || d).join(''); }
             function getNepaliDetails(targetDate) { /* ... keep existing ... */
                  // Basic check for Date object validity
                 if (!(targetDate instanceof Date) || isNaN(targetDate)) { return { year: 0, month: 0, day: 0, monthName: 'Invalid', dayNepali: '०', yearNepali: '०' }; }
                const year = targetDate.getFullYear(); const month = targetDate.getMonth(); const day = targetDate.getDate();
                 const referenceEnglishDate = new Date(2024, 0, 1); const referenceNepaliYear = 2080; const referenceNepaliMonth = 8; const referenceNepaliDay = 16;
                function checkYearData(yr) { if (!nepaliDaysInMonth[yr]) { console.warn(`Nepali month data missing for year ${yr}.`); return nepaliDaysInMonth[2081] || nepaliDaysInMonth[Object.keys(nepaliDaysInMonth)[0]]; } return nepaliDaysInMonth[yr]; }
                const millisecondsPerDay = 86400000; const targetUTC = Date.UTC(year, month, day); const referenceUTC = Date.UTC(referenceEnglishDate.getFullYear(), referenceEnglishDate.getMonth(), referenceEnglishDate.getDate()); const daysDifference = Math.round((targetUTC - referenceUTC) / millisecondsPerDay);
                let nepaliYear = referenceNepaliYear; let nepaliMonth = referenceNepaliMonth; let nepaliDay = referenceNepaliDay; let currentYearData = checkYearData(nepaliYear); let remainingDays = daysDifference;
                if (remainingDays >= 0) { while (remainingDays > 0) { const daysInCurrentMonth = currentYearData[nepaliMonth]; if (!daysInCurrentMonth) { console.error(`Missing days for BS ${nepaliYear}, Month ${nepaliMonth}`); break; } const daysLeftInMonth = daysInCurrentMonth - nepaliDay; if (remainingDays <= daysLeftInMonth) { nepaliDay += remainingDays; remainingDays = 0; } else { remainingDays -= (daysLeftInMonth + 1); nepaliDay = 1; nepaliMonth++; if (nepaliMonth > 11) { nepaliMonth = 0; nepaliYear++; currentYearData = checkYearData(nepaliYear); } } } } else { remainingDays = Math.abs(remainingDays); while (remainingDays > 0) { const daysToSubtract = nepaliDay - 1; if (remainingDays <= daysToSubtract) { nepaliDay -= remainingDays; remainingDays = 0; } else { remainingDays -= (daysToSubtract + 1); nepaliMonth--; if (nepaliMonth < 0) { nepaliMonth = 11; nepaliYear--; currentYearData = checkYearData(nepaliYear); } nepaliDay = currentYearData[nepaliMonth]; if (!nepaliDay) { console.error(`Missing days for BS ${nepaliYear}, Month ${nepaliMonth}`); break; } } } }
                return { year: nepaliYear, month: nepaliMonth, day: nepaliDay, monthName: nepaliMonths[nepaliMonth], dayNepali: toNepaliDigits(nepaliDay), yearNepali: toNepaliDigits(nepaliYear) };
             }
             function getEventsForDate(date) { const dateString = formatDateKey(date); return eventsData[dateString] || []; }
             function formatDateKey(date) { if (!(date instanceof Date) || isNaN(date)) return ''; return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
             function isHoliday(date) { const dateKeyEn = formatDateKey(date); if (holidays.english[dateKeyEn]) return true; const nepaliDate = getNepaliDetails(date); const dateKeyNp = `${nepaliDate.year}-${String(nepaliDate.month + 1).padStart(2, '0')}-${String(nepaliDate.day).padStart(2, '0')}`; return !!holidays.nepali[dateKeyNp]; }
             function getHolidayName(date) { const dateKeyEn = formatDateKey(date); if (holidays.english[dateKeyEn]) return holidays.english[dateKeyEn]; const nepaliDate = getNepaliDetails(date); const dateKeyNp = `${nepaliDate.year}-${String(nepaliDate.month + 1).padStart(2, '0')}-${String(nepaliDate.day).padStart(2, '0')}`; return holidays.nepali[dateKeyNp] || ''; }
             function buildEventMap() { eventsById.clear(); Object.keys(eventsData).forEach(dateKey => { const date = new Date(dateKey + 'T00:00:00'); eventsData[dateKey].forEach(event => eventsById.set(event.id, { ...event, date: date })); }); }
             function getOfferById(offerId) { return eventsById.get(offerId); }
             function showToast(message) { toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 2500); } // Slightly longer toast

            // --- List View Functions ---
            function getSortedEvents() { /* ... keep existing ... */
                 const allEvents = []; Object.keys(eventsData).forEach(dateKey => { const date = new Date(dateKey + 'T00:00:00'); eventsData[dateKey].forEach(event => allEvents.push({ ...event, date: date })); });
                 allEvents.sort((a, b) => { const dateComparison = a.date.getTime() - b.date.getTime(); if (dateComparison !== 0) return dateComparison; const timeA = a.time || ''; const timeB = b.time || ''; if (timeA === 'All Day') return -1; if (timeB === 'All Day') return 1; return timeA.localeCompare(timeB); }); return allEvents;
            }
            function renderListView() {
                console.log("Rendering List View");
                listViewContainer.innerHTML = ''; // Clear previous
                const sortedEvents = getSortedEvents();
                const filteredEvents = selectedCategories.size > 0
                    ? sortedEvents.filter(event => selectedCategories.has(event.category || 'default'))
                    : sortedEvents;

                if (filteredEvents.length === 0) {
                    listViewContainer.innerHTML = `<div class="no-events-list">No events found${selectedCategories.size > 0 ? ' matching filters' : ''}.</div>`;
                    return;
                }

                const groupedByDate = filteredEvents.reduce((acc, event) => {
                    const dateKey = formatDateKey(event.date);
                    if (!acc[dateKey]) acc[dateKey] = { date: event.date, events: [] };
                    acc[dateKey].events.push(event); return acc;
                }, {});

                const fragment = document.createDocumentFragment();
                Object.keys(groupedByDate).sort().forEach(dateKey => {
                    const group = groupedByDate[dateKey];
                    const dateGroupContainer = document.createElement('div');
                    dateGroupContainer.classList.add('list-date-group');
                    const nepaliDate = getNepaliDetails(group.date);
                    const dateHeader = document.createElement('h2');
                    dateHeader.classList.add('list-date-header');
                    dateHeader.innerHTML = `
                        ${group.date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                        <span class="sub-date">/ ${nepaliDate.monthName} ${nepaliDate.dayNepali}, ${nepaliDate.yearNepali}</span>
                    `;
                    dateGroupContainer.appendChild(dateHeader);
                    const eventListUl = document.createElement('ul');
                    group.events.forEach(event => eventListUl.appendChild(createEventItemElement(event, group.date)));
                    dateGroupContainer.appendChild(eventListUl);
                    fragment.appendChild(dateGroupContainer);
                });
                listViewContainer.appendChild(fragment);
                 console.log("List View finished rendering");
            }

            // --- Calendar Rendering (Lazy Loaded) ---
            function initializeCalendarDOM() { /* ... keep existing ... */
                calendarViewContainer.innerHTML = `...`; // Paste the full HTML structure here from previous answer
                 calendarViewContainer.innerHTML = `
                     <div class="calendar-main">
                         <div class="calendar-header">
                             <button id="prev-month" class="nav-button" aria-label="Previous Month"><i class="fas fa-chevron-left"></i></button>
                             <h2 id="month-year" aria-live="polite">Month Year</h2>
                             <button id="next-month" class="nav-button" aria-label="Next Month"><i class="fas fa-chevron-right"></i></button>
                         </div>
                         <div class="calendar-config">
                             <label class="toggle-switch" for="nepali-date-toggle">
                                 <span>Show Nepali Dates</span>
                                 <input type="checkbox" id="nepali-date-toggle">
                                 <span class="slider"></span>
                             </label>
                         </div>
                         <div class="calendar-weekdays">
                             <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
                             <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div>
                             <div class="weekday">Sat</div>
                         </div>
                         <div id="calendar-days" class="calendar-days" role="grid"></div>
                     </div>
                     <aside id="events-panel" aria-labelledby="event-panel-date">
                         <div class="event-panel-header">
                             <div id="event-panel-date">Select a date</div>
                         </div>
                         <ul id="event-panel-list" class="event-panel-list">
                             <li class="no-events">Select a date to see events.</li>
                         </ul>
                     </aside>
                 `;

                 // Re-assign DOM element variables
                 prevMonthBtn = document.getElementById('prev-month');
                 nextMonthBtn = document.getElementById('next-month');
                 monthYearDisplay = document.getElementById('month-year');
                 calendarDaysContainer = document.getElementById('calendar-days');
                 nepaliDateToggle = document.getElementById('nepali-date-toggle');
                 eventsPanel = document.getElementById('events-panel');
                 eventPanelDate = document.getElementById('event-panel-date');
                 eventPanelList = document.getElementById('event-panel-list');

                 // Add event listeners
                 prevMonthBtn?.addEventListener('click', () => changeMonth(-1));
                 nextMonthBtn?.addEventListener('click', () => changeMonth(1));
                 nepaliDateToggle?.addEventListener('change', (event) => {
                     showNepaliDates = event.target.checked;
                     if (currentView === 'calendar') renderCalendar(currentMonth, currentYear);
                 });

                 showNepaliDates = nepaliDateToggle.checked;
                 calendarRendered = true;
                 console.log("Calendar DOM initialized.");
            }
            function renderCalendar(month, year) { /* ... keep existing ... */
                 if (!calendarRendered) return;
                console.log(`Rendering calendar for: ${year}-${month + 1}`);
                const nepaliHeaderDate = getNepaliDetails(new Date(year, month, 1));
                monthYearDisplay.textContent = `${new Date(year, month).toLocaleString('en-US', { month: 'long' })} ${year} / ${nepaliHeaderDate.monthName} ${nepaliHeaderDate.yearNepali}`;

                const fragment = document.createDocumentFragment();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();
                const today = new Date(); today.setHours(0, 0, 0, 0);

                for (let i = firstDayOfMonth - 1; i >= 0; i--) { fragment.appendChild(createDayElement(year, month - 1, daysInPrevMonth - i, true)); }
                for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) {
                    const dayElement = createDayElement(year, month, dayNum, false);
                    const currentDate = new Date(year, month, dayNum); currentDate.setHours(0, 0, 0, 0);
                    if (currentDate.getTime() === today.getTime()) { dayElement.classList.add('today'); }
                    if (selectedDate && currentDate.getFullYear() === selectedDate.getFullYear() && currentDate.getMonth() === selectedDate.getMonth() && currentDate.getDate() === selectedDate.getDate()) { dayElement.classList.add('selected'); }
                    if (isHoliday(currentDate)) { dayElement.classList.add('holiday'); dayElement.setAttribute('title', getHolidayName(currentDate)); }
                    addEventIndicators(dayElement, currentDate);
                    dayElement.addEventListener('click', () => handleDateClick(dayElement, currentDate));
                    fragment.appendChild(dayElement);
                }
                const totalDaysRendered = firstDayOfMonth + daysInMonth;
                const nextMonthDaysToAdd = (7 - (totalDaysRendered % 7)) % 7;
                for (let i = 1; i <= nextMonthDaysToAdd; i++) { fragment.appendChild(createDayElement(year, month + 1, i, true)); }

                calendarDaysContainer.innerHTML = ''; calendarDaysContainer.appendChild(fragment); calendarDaysContainer.classList.toggle('nepali-visible', showNepaliDates);
                calendarDaysContainer.classList.remove('fade-in'); void calendarDaysContainer.offsetWidth; calendarDaysContainer.classList.add('fade-in');
            }
            function createDayElement(year, month, dayNum, isInactive) { /* ... keep existing ... */
                 const dayElement = document.createElement('div');
                 dayElement.classList.add('day');
                 if (isInactive) dayElement.classList.add('inactive');
                 const currentDate = new Date(year, month, dayNum);
                 const dateString = formatDateKey(currentDate);
                 dayElement.dataset.date = dateString;
                 const nepDate = getNepaliDetails(currentDate);
                 dayElement.innerHTML = `<div class="day-dates"><span class="eng-date">${dayNum}</span><span class="nepali-date">${nepDate.dayNepali}</span></div><div class="event-indicator"></div>`;
                 return dayElement;
            }
            function addEventIndicators(dayElement, date) { /* ... keep existing ... */
                 const events = getEventsForDate(date);
                 const indicatorContainer = dayElement.querySelector('.event-indicator');
                 if (events.length > 0 && indicatorContainer) {
                     dayElement.classList.add('has-events');
                     const maxDots = isMobileView ? 3 : 4;
                     const uniqueCategories = [...new Set(events.map(e => e.category || 'default'))];
                     let dotCount = 0;
                     uniqueCategories.slice(0, maxDots).forEach(category => {
                         const dot = document.createElement('span'); dot.classList.add('event-dot'); dot.style.backgroundColor = categoryConfig[category]?.color || categoryConfig.default.color;
                         indicatorContainer.appendChild(dot); dotCount++;
                     });
                     const remainingEvents = events.length - dotCount; const remainingCategories = uniqueCategories.length - dotCount;
                     if (events.length > maxDots) {
                         const countBadge = document.createElement('span'); countBadge.classList.add('event-count');
                         countBadge.textContent = (remainingCategories <= 0) ? `+${remainingEvents}` : '+';
                         indicatorContainer.appendChild(countBadge);
                     }
                 }
            }

            // --- Event Handling ---
            function handleDateClick(dayElement, date) { /* ... keep existing (only for Calendar) ... */
                 console.log("Calendar Date clicked:", date.toDateString());
                const previouslySelected = calendarDaysContainer.querySelector('.day.selected');
                if (previouslySelected) previouslySelected.classList.remove('selected');
                dayElement.classList.add('selected');
                selectedDate = date;
                updateEventsPanel(date);
            }
            function updateEventsPanel(date) { /* ... keep existing (only for Calendar) ... */
                 if (!eventsPanel) return;
                 if (!date) { eventPanelDate.innerHTML = 'Select a date'; eventPanelList.innerHTML = '<li class="no-events">Select a date.</li>'; const b = eventPanelDate.querySelector('.holiday-badge'); if(b) b.remove(); return; }
                 const events = getEventsForDate(date); const nepaliDate = getNepaliDetails(date); const holidayName = getHolidayName(date);
                 eventPanelDate.innerHTML = `${date.toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' })}<span class="sub-date">${nepaliDate.monthName} ${nepaliDate.dayNepali}, ${nepaliDate.yearNepali}</span>`;
                 const b = eventPanelDate.querySelector('.holiday-badge'); if(b) b.remove();
                 if (holidayName) { const badge = document.createElement('div'); badge.className = 'holiday-badge'; badge.textContent = holidayName; eventPanelDate.appendChild(badge); }
                 const filteredEvents = selectedCategories.size > 0 ? events.filter(event => selectedCategories.has(event.category || 'default')) : events;
                 eventPanelList.innerHTML = '';
                 if (filteredEvents.length > 0) {
                    filteredEvents.sort((a, b) => { const tA = a.time || ''; const tB = b.time || ''; if (tA === 'All Day') return -1; if (tB === 'All Day') return 1; return tA.localeCompare(tB); });
                    filteredEvents.forEach(event => eventPanelList.appendChild(createEventItemElement(event, date)));
                 } else { eventPanelList.innerHTML = `<li class="no-events">${selectedCategories.size > 0 ? 'No events match filters.' : 'No events scheduled.'}</li>`; }
            }
            // --- MODIFIED: createEventItemElement (Adds Image) ---
            function createEventItemElement(event, date) {
                 const li = document.createElement('li');
                 li.classList.add('event-item');
                 li.dataset.eventId = event.id;
                 const category = event.category || 'default';
                 const categoryInfo = categoryConfig[category] || categoryConfig.default;
                 const hasImage = !!event.imageUrl;
                 const hasDescription = !!event.description;

                 li.innerHTML = `
                     <div class="event-card ${hasImage ? 'has-image' : ''} ${hasDescription ? 'has-description' : ''}" title="Click for details">
                         ${hasImage ? `
                             <div class="event-image-container">
                                 <img src="${event.imageUrl}" alt="${event.name || 'Event Image'}" loading="lazy">
                             </div>
                         ` : ''}
                         <div class="event-content-wrapper">
                             <div class="event-header">
                                 <span class="event-icon" aria-hidden="true" style="color: ${categoryInfo.color}">${categoryInfo.icon}</span>
                                 <span class="event-name">${event.name || 'Untitled Event'}</span>
                             </div>
                             <div class="event-details">
                                 ${event.time ? `<span class="event-time">${event.time}</span>` : ''}
                                 ${event.location ? `<span class="event-location">${event.location}</span>` : ''}
                             </div>
                              ${hasDescription ? `<div class="event-description">${event.description}</div>` : ''}
                         </div>
                     </div>
                 `;
                 const card = li.querySelector('.event-card');
                 if (card) {
                    // Use event object directly from closure
                    card.addEventListener('click', () => showEventDetails(event, date));
                 }
                 return li;
             }

            function updateCategoryFilters(allEventsData) { /* ... keep existing (Shared filter update) ... */
                 if (!eventCategoriesFilter) return;
                 const allCategories = new Set(['all']); Object.values(allEventsData).flat().forEach(event => allCategories.add(event.category || 'default'));
                 eventCategoriesFilter.innerHTML = ''; const sortedCategories = [...allCategories].sort((a,b) => a === 'all' ? -1 : b === 'all' ? 1: a.localeCompare(b));
                 sortedCategories.forEach(category => {
                      const categoryInfo = categoryConfig[category] || categoryConfig.default;
                     const filterOption = document.createElement('button'); filterOption.classList.add('category-filter'); filterOption.dataset.category = category;
                     if (category === 'all') { filterOption.innerHTML = `<span class="category-name">All</span>`; }
                     else { filterOption.innerHTML = `<span class="category-dot" style="background-color: ${categoryInfo.color}"></span><span class="category-name">${category.charAt(0).toUpperCase() + category.slice(1)}</span>`; }
                     if ((category === 'all' && selectedCategories.size === 0) || selectedCategories.has(category)) { filterOption.classList.add('selected'); }
                     filterOption.addEventListener('click', () => handleCategoryFilterClick(category)); eventCategoriesFilter.appendChild(filterOption);
                 });
                 // Modal select removed
            }
            function handleCategoryFilterClick(clickedCategory) { /* ... keep existing (Global filter handler) ... */
                 const allButton = eventCategoriesFilter.querySelector('[data-category="all"]');
                 if (clickedCategory === 'all') { selectedCategories.clear(); }
                 else { if (selectedCategories.has(clickedCategory)) { selectedCategories.delete(clickedCategory); } else { selectedCategories.add(clickedCategory); } }
                 document.querySelectorAll('#event-categories-filter .category-filter').forEach(btn => { const c = btn.dataset.category; if (c === 'all') { btn.classList.toggle('selected', selectedCategories.size === 0); } else { btn.classList.toggle('selected', selectedCategories.has(c)); } });
                 if (selectedCategories.size > 0) { allButton?.classList.remove('selected'); }
                 if (currentView === 'list') { renderListView(); } else if (currentView === 'calendar' && selectedDate) { updateEventsPanel(selectedDate); }
            }
            function changeMonth(offset) { /* ... keep existing (Only for Calendar View) ... */
                 if (!calendarRendered) return; // Don't change month if calendar isn't visible
                 calendarDaysContainer.classList.add('fade-out');
                 setTimeout(() => {
                    currentMonth += offset; if (currentMonth < 0) { currentMonth = 11; currentYear--; } else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                    renderCalendar(currentMonth, currentYear);
                    selectedDate = null; updateEventsPanel(null);
                    calendarDaysContainer.classList.remove('fade-out');
                 }, 150);
            }
            function toggleModal(modalElement, forceShow = null) { /* ... keep generic ... */
                 if (!modalElement) return;
                 const isActive = modalElement.classList.contains('active'); const show = forceShow !== null ? forceShow : !isActive;
                 modalElement.classList.toggle('active', show); modalElement.setAttribute('aria-hidden', String(!show));
            }

            // --- MODIFIED: Event Details Modal Logic (Handles Image) ---
            function showEventDetails(event, date) {
                if (!event || !date) return;
                 const nepDate = getNepaliDetails(date);
                 const category = event.category || 'default';
                 const categoryInfo = categoryConfig[category] || categoryConfig.default;

                 // Image Handling
                 if (event.imageUrl) {
                     detailImage.src = event.imageUrl;
                     detailImage.alt = event.name || 'Event Image';
                     detailImageWrapper.style.display = 'block';
                 } else {
                     detailImageWrapper.style.display = 'none';
                 }

                 // Populate Text Details
                 eventDetailTitle.textContent = event.name || 'Event Details';
                 detailDate.textContent = `${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} / ${nepDate.monthName} ${nepDate.dayNepali}, ${nepDate.yearNepali}`;
                 detailTimeItem.style.display = event.time ? 'flex' : 'none'; detailTime.textContent = event.time || '';
                 detailLocationItem.style.display = event.location ? 'flex' : 'none'; detailLocation.textContent = event.location || '';
                 detailCategoryItem.style.display = (category !== 'default') ? 'flex' : 'none'; detailCategory.textContent = category.charAt(0).toUpperCase() + category.slice(1); detailCategory.style.color = categoryInfo.color;
                 detailDescriptionItem.style.display = event.description ? 'block' : 'none'; detailDescription.textContent = event.description || '';

                 // Share Button Listeners (use closure to capture event.id)
                 const currentEventId = event.id;
                 detailShareWhatsapp.onclick = () => shareViaWhatsApp(currentEventId);
                 detailShareCopy.onclick = () => copyOfferLink(currentEventId);

                 toggleModal(eventDetailsModal, true);
            }

            // --- Sharing Functions ---
             function generateOfferLink(offerId) { /* ... keep existing ... */
                  const url = new URL(window.location.origin + window.location.pathname); url.searchParams.set('view', 'list'); url.searchParams.set('offerId', offerId); return url.toString();
             }
             function shareViaWhatsApp(offerId) { /* ... keep existing ... */
                 const offer = getOfferById(offerId); if (!offer) return; const offerDateStr = offer.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); const offerText = `Check out this offer: ${offer.name} (${offer.time || 'All Day'}) on ${offerDateStr}!`; const offerUrl = generateOfferLink(offerId); const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(offerText + '\n' + offerUrl)}`; window.open(whatsappUrl, '_blank');
             }
            function copyOfferLink(offerId) { /* ... keep existing ... */
                 const offer = getOfferById(offerId); if (!offer) return; const linkToCopy = generateOfferLink(offerId);
                 if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(linkToCopy).then(() => { showToast('Link Copied!'); }).catch(err => { console.error('Failed to copy link: ', err); showToast('Copy failed'); }); } else { try { const t = document.createElement("textarea"); t.value = linkToCopy; t.style.position = "fixed"; t.style.left = "-9999px"; document.body.appendChild(t); t.focus(); t.select(); document.execCommand('copy'); showToast('Link Copied! (Fallback)'); document.body.removeChild(t); } catch (e) { showToast('Copy failed'); } }
             }

            // --- Deep Linking Function ---
             function handleDeepLink() { /* ... keep existing ... */
                 const urlParams = new URLSearchParams(window.location.search); const offerId = urlParams.get('offerId');
                 if (offerId) {
                     console.log("Deep link detected for offerId:", offerId); const offer = getOfferById(offerId);
                     if (offer) {
                          switchView('calendar'); // Ensure list view is active
                          setTimeout(() => {
                              const element = listViewContainer.querySelector(`.event-item[data-event-id="${offerId}"] .event-card`);
                              if (element) {
                                   console.log("Highlighting element:", element); element.scrollIntoView({ behavior: 'smooth', block: 'center' }); element.classList.add('highlight');
                                  setTimeout(() => element.classList.remove('highlight'), 2500);
                              } else { console.warn("Deep link target element not found:", offerId); }
                          }, 400); // Increased delay slightly for render
                     } else { console.warn("Deep link offerId not found:", offerId); }
                 }
             }

            // --- View Switching Logic ---
             function switchView(viewName) {
                 if (currentView === viewName && calendarRendered) return; // Avoid unnecessary switches/renders

                 // Special case: Lazy load calendar
                 if (viewName === 'calendar' && !calendarRendered) {
                     initializeCalendarDOM(); // Create calendar HTML and listeners
                 }

                 currentView = viewName;
                 console.log("Switching to view:", currentView);
                 viewTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.view === viewName));
                 viewContainers.forEach(container => container.classList.toggle('active', container.id === `${viewName}-view-container`));

                 if (viewName === 'list') {
                     renderListView(); // Always render list when switched to
                 } else if (viewName === 'calendar' && calendarRendered) {
                     // Calendar is initialized, render its current state
                     renderCalendar(currentMonth, currentYear);
                     updateEventsPanel(selectedDate);
                 }
             }

            // --- Event Listeners ---
             viewTabs.forEach(tab => tab.addEventListener('click', () => switchView(tab.dataset.view)));
             closeDetailModalBtn?.addEventListener('click', () => toggleModal(eventDetailsModal, false));
             eventDetailsModal?.addEventListener('click', (event) => { if (event.target === eventDetailsModal) toggleModal(eventDetailsModal, false); });
             document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && eventDetailsModal?.classList.contains('active')) { toggleModal(eventDetailsModal, false); } });
             window.addEventListener('resize', () => { /* Keep existing resize logic */
                 const currentlyMobile = window.innerWidth < 768;
                 if (currentlyMobile !== isMobileView) {
                    isMobileView = currentlyMobile;
                     if (currentView === 'calendar' && calendarRendered) {
                         renderCalendar(currentMonth, currentYear); if (selectedDate) { const d = formatDateKey(selectedDate); const el = calendarDaysContainer.querySelector(`.day[data-date="${d}"]`); if (el) el.classList.add('selected'); }
                     } else if (currentView === 'list') { renderListView(); } // Re-render list on resize for potentially different image sizes etc.
                    console.log("View resized. isMobileView:", isMobileView);
                 }
             });

            // --- Initial Setup ---
            handleResize();
            buildEventMap();
            updateCategoryFilters(eventsData);
            switchView('calendar'); // Ensure 'calendar' view is activated and rendered immediately
            handleDeepLink(); // Check for deep link

            console.log("Khojum V3 Initialized. Default: Calendar");

        }); // End DOMContentLoaded
    </script>

</body>
</html>

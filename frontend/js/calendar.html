<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Khojum Calendar | Month & Year View (LocalStorage)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Base & Enhanced Variables (Keep As Is) --- */
        :root {
            --font-primary: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --font-nepali: 'Noto Sans Devanagari', var(--font-primary);
            --c-primary: #5b6d97; --c-secondary: #87CEEB; --c-accent: #f7a8c0;
            --c-text-dark: #2c3e50; --c-text-light: #95a5a6; --c-text-muted: #bdc3c7;
            --c-bg-main: #f4f7fc; --c-bg-container: #ffffff; --c-border: #e4e9f0;
            --c-today-bg: color-mix(in srgb, var(--c-secondary) 25%, transparent);
            --c-today-border: color-mix(in srgb, var(--c-secondary) 70%, transparent);
            --c-selected-border: var(--c-primary);
            --c-selected-bg: color-mix(in srgb, var(--c-primary) 15%, transparent);
            --c-holiday-text: #27ae60; --c-event-dot-size: 5px; --c-danger: #e74c3c;
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-medium: 0 4px 10px rgba(0, 0, 0, 0.08);
            --shadow-heavy: 0 8px 25px rgba(0, 0, 0, 0.1);
            --transition-fast: 0.2s ease; --transition-medium: 0.3s ease; --transition-slow: 0.4s ease;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--font-primary); margin: 0; background-color: var(--c-bg-main); color: var(--c-text-dark); line-height: 1.6; font-size: 16px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; padding: 1rem; }
        button { cursor: pointer; border: none; background: none; padding: 0; font-family: inherit; color: inherit; }
        ul { list-style: none; padding: 0; margin: 0; }
        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 600; }
    
        /* --- Main Calendar Container --- */
        #calendar-container { background-color: var(--c-bg-container); border-radius: 12px; box-shadow: var(--shadow-medium); overflow: hidden; width: 100%; max-width: 1200px; margin: 1rem auto; display: flex; flex-direction: column; }
        /* --- Calendar Header --- */
        .calendar-header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid var(--c-border); background-color: #fdfdff; gap: 10px 15px; /* Row and column gap */ }
        .calendar-title { flex-basis: 100%; /* Default to full width for potential stacking */ order: 1; /* Default order */ text-align: center; }
        #month-year, #year-view-title { font-size: 1.4em; font-weight: 600; color: var(--c-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; order: 2; /* Default order */}
        .header-controls.view-switcher { order: 3; /* View switcher last by default */}
    
        .view-switcher button, .nav-button, .today-button { padding: 8px 12px; border-radius: 6px; font-size: 0.9em; font-weight: 500; transition: background-color var(--transition-fast), color var(--transition-fast), box-shadow var(--transition-fast); border: 1px solid var(--c-border); background-color: #fff; }
        .view-switcher button.active, .nav-button:hover, .today-button:hover { background-color: var(--c-primary); color: white; border-color: var(--c-primary); box-shadow: var(--shadow-subtle); }
        .view-switcher button:not(.active):hover { background-color: #f5f5f5; }
        .nav-button { padding: 0; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; font-size: 1em; }
    
        /* --- View Container --- */
        .calendar-view-container { display: flex; flex-grow: 1; overflow: hidden; min-height: 500px; /* Ensure container has height */ width: 100%; /* Ensure it takes width */}
    
        /* --- Month View Structure --- */
        #calendar-month-view { display: flex; flex-grow: 1; width: 100%; overflow: hidden; }
        .calendar-grid-area { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; min-width: 0; /* Prevent flex item overflow */ }
        /* Config Area */
        .calendar-config { display: flex; justify-content: flex-end; align-items: center; padding: 10px 20px; border-bottom: 1px solid var(--c-border); background-color: #fafbff; font-size: 0.85em; flex-shrink: 0; }
        .toggle-switch { display: flex; align-items: center; cursor: pointer; color: var(--c-text-light); }
        .toggle-switch span { margin-right: 8px;}
        .toggle-switch input { display: none; }
        .toggle-switch .slider { width: 40px; height: 20px; background-color: #ccc; border-radius: 20px; position: relative; transition: background-color var(--transition-medium); }
        .toggle-switch .slider::before { content: ""; position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: transform var(--transition-medium); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .toggle-switch input:checked + .slider { background-color: var(--c-primary); }
        .toggle-switch input:checked + .slider::before { transform: translateX(20px); }
        /* Weekdays */
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); padding: 10px 5px; background-color: #fafbff; border-bottom: 1px solid var(--c-border); flex-shrink: 0; }
        .weekday { text-align: center; font-weight: 600; font-size: 0.8em; color: var(--c-text-light); text-transform: uppercase; }
        /* Days Grid */
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: var(--c-border); flex-grow: 1; overflow-y: auto; padding: 1px; transition: opacity var(--transition-fast); }
        .calendar-days.fade-out { opacity: 0; }
        .calendar-days.fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Day Cell */
        .day { background-color: var(--c-bg-container); padding: 6px; position: relative; min-height: 100px; /* Increased min-height slightly */ cursor: pointer; transition: background-color var(--transition-fast); display: flex; flex-direction: column; font-size: 0.9em; overflow: hidden; }
        .day:hover:not(.inactive) { background-color: color-mix(in srgb, var(--c-secondary) 10%, transparent); }
        .day.inactive { background-color: var(--c-bg-main); color: var(--c-text-muted); cursor: default; }
        /* Date Display */
        .day-dates { display: flex; justify-content: space-between; align-items: baseline; line-height: 1.3; margin-bottom: 5px; }
        .date-en, .date-np { transition: all var(--transition-slow); display: inline-block; font-weight: 400; word-break: keep-all; /* Prevent breaking numbers */ white-space: nowrap; }
        .date-en { font-size: 1.1em; color: var(--c-text-dark); }
        .date-np { font-size: 0.9em; color: var(--c-text-light); font-family: var(--font-nepali); }
        /* Date Emphasis Animation (Keep As Is) */
        #calendar-container.nepali-primary .date-np { font-weight: 700; font-size: 1.25em; color: var(--c-text-dark); transform: scale(1.1) translateX(-2px); opacity: 1; }
        #calendar-container.nepali-primary .date-en { font-weight: 400; font-size: 0.85em; color: var(--c-text-light); transform: scale(0.9) translateX(2px); opacity: 0.6; }
        #calendar-container:not(.nepali-primary) .date-en { font-weight: 700; font-size: 1.25em; color: var(--c-text-dark); transform: scale(1.1); opacity: 1; }
        #calendar-container:not(.nepali-primary) .date-np { font-weight: 400; font-size: 0.85em; color: var(--c-text-light); transform: scale(0.9); opacity: 0.6; }
        .day.inactive .date-en, .day.inactive .date-np { color: var(--c-text-muted) !important; opacity: 0.7; transform: none !important;}
        /* Today & Selected Styles */
        .day.today { background-color: var(--c-today-bg); border-radius: 4px; border: 1px solid var(--c-today-border); }
        .day.today .date-en, .day.today .date-np { font-weight: 700 !important; }
        .day.selected { background-color: var(--c-selected-bg); box-shadow: inset 0 0 0 2px var(--c-selected-border); border-radius: 4px; }
        /* Holiday Indicator */
        .day.holiday { border-bottom: 3px solid var(--c-holiday-text); padding-bottom: 3px;}
        .day.holiday .date-en, .day.holiday .date-np { color: var(--c-holiday-text); font-weight: 600; }
        /* Event Indicator Area */
        .event-indicator { display: flex; flex-wrap: wrap; gap: 3px; margin-top: auto; padding-top: 4px; max-height: 20px; overflow: hidden; }
        .event-dot { width: var(--c-event-dot-size); height: var(--c-event-dot-size); border-radius: 50%; flex-shrink: 0; }
        .event-count { font-size: 0.75em; font-weight: bold; color: var(--c-text-light); margin-left: 3px; background: rgba(0,0,0,0.04); padding: 0 4px; border-radius: 4px; line-height: 1.2; align-self: center; }
    
        /* --- Events Side Panel (Month View Only, Desktop) --- */
        #events-panel {
            width: 320px; flex-shrink: 0; border-left: 1px solid var(--c-border);
            display: flex; flex-direction: column; background-color: #fdfdff;
            transition: width var(--transition-medium), opacity var(--transition-medium), visibility var(--transition-medium), border var(--transition-medium);
            overflow: hidden;
        }
        /* Hide panel in year view */
        #calendar-container.view-year #events-panel {
            width: 0 !important; opacity: 0 !important; visibility: hidden !important; border-left: none !important; padding: 0 !important; margin: 0 !important;
            display: none; /* Also set display none for good measure */
        }
        /* Events Panel content styling (Keep As Is) */
        .event-panel-header { padding: 18px 25px; border-bottom: 1px solid var(--c-border); flex-shrink: 0; background: #fbfbff; }
        #event-panel-date { font-weight: 600; font-size: 1.1em; color: var(--c-primary); }
        #event-panel-date .sub-date { font-size: 0.8em; color: var(--c-text-light); display: block; }
        .holiday-badge { display: inline-block; background-color: var(--c-holiday-text); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 500; margin-top: 5px; }
        #event-categories-filter { display: flex; flex-wrap: nowrap; gap: 8px; padding: 12px 20px; border-bottom: 1px solid var(--c-border); flex-shrink: 0; overflow-x: auto; background: #fbfbff; scrollbar-width: thin; scrollbar-color: var(--c-border) transparent; }
        #event-categories-filter::-webkit-scrollbar { height: 4px; } #event-categories-filter::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 2px; }
        .category-filter { display: flex; align-items: center; cursor: pointer; padding: 5px 12px; border-radius: 18px; background-color: #f0f3f7; font-size: 0.8em; transition: all var(--transition-fast); white-space: nowrap; border: 1px solid transparent; }
        .category-filter:hover { background-color: #e8eaf0; }
        .category-filter.selected { background-color: color-mix(in srgb, var(--c-primary) 15%, transparent); color: var(--c-primary); font-weight: 600; border-color: color-mix(in srgb, var(--c-primary) 30%, transparent); box-shadow: var(--shadow-subtle); }
        .category-dot { width: 9px; height: 9px; border-radius: 50%; margin-right: 6px; flex-shrink: 0; }
        .category-name { color: var(--c-text-dark); }
        .category-filter.selected .category-name { color: var(--c-primary); }
        .event-panel-list { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .event-item { position: relative; }
        .event-item:not(:last-child) { margin-bottom: 10px; }
        .event-card { background-color: var(--c-bg-container); padding: 12px; border-radius: 8px; border-left: 5px solid var(--c-text-light); transition: all var(--transition-fast); display: flex; justify-content: space-between; align-items: flex-start; box-shadow: var(--shadow-subtle); }
        .event-card:hover { box-shadow: var(--shadow-medium); transform: translateY(-2px); }
        .event-content-wrapper { flex-grow: 1; margin-right: 10px; min-width: 0; } /* Allow shrinking */
        .event-header { display: flex; align-items: center; margin-bottom: 5px; }
        .event-icon { margin-right: 8px; font-size: 1.1em; flex-shrink: 0; }
        .event-name { font-weight: 600; color: var(--c-text-dark); font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .event-details { font-size: 0.85em; color: var(--c-text-light); display: flex; gap: 12px; flex-wrap: wrap; margin-top: 3px; }
        .event-time::before, .event-location::before { font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 4px; font-size: 0.9em; }
        .event-time::before { content: "\f017"; } .event-location::before { content: "\f3c5"; }
        .event-description { font-size: 0.8em; margin-top: 6px; color: var(--c-text-dark); word-break: break-word; }
        .delete-event { color: var(--c-danger); font-size: 1.2em; font-weight: bold; opacity: 0.3; transition: all var(--transition-fast); flex-shrink: 0; padding: 5px; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; }
        .delete-event:hover { background-color: #fde0e0; opacity: 1; transform: scale(1.1); }
        .no-events { padding: 40px 15px; text-align: center; color: var(--c-text-light); font-style: normal; font-size: 0.9em; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; height: 100%; }
        .no-events::before { content: "\f11a"; font-family: 'Font Awesome 6 Free'; font-weight: 400; font-size: 2.5em; color: var(--c-border); }
    
        /* --- Year View Structure --- */
        #calendar-year-view { flex-grow: 1; padding: 20px; display: grid; gap: 25px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); overflow-y: auto; background-color: var(--c-bg-main); }
        /* Initially hide year view */
        #calendar-year-view { display: none; }
        #calendar-container.view-year #calendar-year-view { display: grid; }
        #calendar-container.view-year #calendar-month-view { display: none; }
    
        .mini-month { background-color: var(--c-bg-container); border-radius: 8px; padding: 10px; box-shadow: var(--shadow-subtle); border: 1px solid var(--c-border); }
        .mini-month-header { text-align: center; font-weight: 600; font-size: 1em; color: var(--c-primary); margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid var(--c-border); }
        .mini-calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 4px; }
        .mini-weekday { text-align: center; font-weight: 600; font-size: 0.7em; color: var(--c-text-light); }
        .mini-calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
        .mini-day { text-align: center; font-size: 0.75em; padding: 3px 0; border-radius: 3px; min-height: 28px; line-height: 1.2; position: relative; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; }
        .mini-day:hover { background-color: #f0f0f0; }
        .mini-day.inactive { color: var(--c-text-muted); cursor: default; pointer-events: none; }
        .mini-day.today { background-color: var(--c-today-bg); font-weight: bold; color: var(--c-text-dark); border: 1px solid var(--c-today-border); }
        .mini-day.holiday { color: var(--c-holiday-text); font-weight: bold; border-bottom: 1px solid var(--c-holiday-text);}
        /* Mini day date styles + emphasis (Keep As Is) */
        .mini-day .date-en { font-size: 0.9em; font-weight: 500; transition: all var(--transition-slow); }
        .mini-day .date-np { font-size: 0.7em; font-family: var(--font-nepali); color: var(--c-text-light); transition: all var(--transition-slow); }
        #calendar-container.nepali-primary .mini-day .date-np { font-weight: 600; font-size: 0.9em; color: var(--c-text-dark); transform: scale(1.05); }
        #calendar-container.nepali-primary .mini-day .date-en { font-size: 0.7em; color: var(--c-text-light); opacity: 0.7; transform: scale(0.95); }
        #calendar-container:not(.nepali-primary) .mini-day .date-en { font-weight: 600; font-size: 0.9em; color: var(--c-text-dark); transform: scale(1.05); }
        #calendar-container:not(.nepali-primary) .mini-day .date-np { font-size: 0.7em; color: var(--c-text-light); opacity: 0.7; transform: scale(0.95); }
        .mini-day.inactive .date-en, .mini-day.inactive .date-np { color: var(--c-text-muted) !important; transform: none; }
    
        /* --- Add Event Modal & Button (Keep As Is) --- */
        #add-event-button.fab { position: fixed; bottom: 20px; right: 20px; z-index: 999; background-color: var(--c-accent); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8em; cursor: pointer; box-shadow: var(--shadow-medium); transition: transform var(--transition-fast), box-shadow var(--transition-fast); }
        #add-event-button.fab:hover { transform: scale(1.08); box-shadow: var(--shadow-heavy); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1050; opacity: 0; visibility: hidden; transition: opacity var(--transition-medium), visibility 0s var(--transition-medium); }
        .modal-overlay.active { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content { background-color: var(--c-bg-container); padding: 25px; border-radius: 12px; box-shadow: var(--shadow-heavy); width: 90%; max-width: 450px; position: relative; transform: scale(0.9); transition: transform var(--transition-medium); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.3em; color: var(--c-primary); }
        .modal-close-button { /* Uses .nav-button styles */ }
        .modal-body form { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 0.85em; color: var(--c-text-light); margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid var(--c-border); border-radius: 6px; font-size: 0.95em; font-family: inherit; transition: border-color var(--transition-fast), box-shadow var(--transition-fast); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--c-primary); box-shadow: 0 0 0 2px color-mix(in srgb, var(--c-primary) 20%, transparent); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .modal-footer { margin-top: 25px; text-align: right; }
        .modal-button { padding: 10px 20px; border-radius: 6px; font-size: 0.95em; font-weight: 500; transition: background-color var(--transition-fast), color var(--transition-fast); border: none; }
        .modal-button.primary { background-color: var(--c-primary); color: white; }
        .modal-button.primary:hover { background-color: color-mix(in srgb, var(--c-primary) 85%, black); }
        .modal-button.secondary { background-color: #eef1f5; color: var(--c-text-dark); margin-right: 10px; }
        .modal-button.secondary:hover { background-color: #dfe4ea; }
    
        /* --- Mobile Responsiveness Adjustments --- */
        @media (max-width: 768px) {
            body { font-size: 14px; padding: 0.5rem; }
            #calendar-container { margin: 0.5rem auto; border-radius: 8px; display: flex; flex-direction: column; /* Ensure stacking */ } /* Added flex properties */
    
            /* --- Mobile Header --- */
            .calendar-header {
                padding: 12px;
                flex-direction: column; /* Stack everything vertically */
                align-items: stretch; /* Stretch items full width */
            }
            .calendar-title {
                order: 1; /* Title first */
                text-align: center;
                margin-bottom: 12px;
                flex-basis: auto; /* Reset basis */
            }
            /* Group nav buttons and today together */
            .header-controls.month-controls, .header-controls.year-controls {
                order: 2; /* Nav buttons second */
                justify-content: center; /* Center buttons */
                width: 100%;
            }
            .header-controls.view-switcher {
                order: 3; /* View switcher last */
                justify-content: center;
                width: 100%;
                margin-top: 8px; /* Add space above view switcher */
            }
            .nav-button { width: 34px; height: 34px; font-size: 0.9em;}
            .view-switcher button, .today-button { padding: 7px 11px; font-size: 0.85em;}
            #month-year, #year-view-title { font-size: 1.3em; }
    
            /* --- Mobile View Container & Panel --- */
            .calendar-view-container {
                 flex-direction: column; /* Stack views (though only one is visible) */
                 min-height: auto; /* Allow container to shrink */
            }
            #calendar-month-view {
                 flex-direction: column; /* Stack grid area */
            }
            #events-panel {
                display: none !important; /* Explicitly hide on mobile */
                width: 0 !important; height: 0 !important; opacity: 0 !important;
                visibility: hidden !important; border: none !important;
                padding: 0 !important; margin: 0 !important;
                overflow: hidden !important;
            }
    
            /* --- Mobile Month View Grid --- */
            .calendar-config { padding: 8px 12px; }
            .calendar-weekdays { padding: 8px 2px; }
            .weekday { font-size: 0.7em; }
            .day {
                 min-height: 75px; /* Adjust height for better touch targets */
                 padding: 5px;
                 font-size: 0.85em;
            }
            /* Adjust date sizes for mobile */
            .date-en, #calendar-container:not(.nepali-primary) .date-en { font-size: 1.1em; }
            .date-np, #calendar-container:not(.nepali-primary) .date-np { font-size: 0.85em; }
            #calendar-container.nepali-primary .date-np { font-size: 1.1em; }
            #calendar-container.nepali-primary .date-en { font-size: 0.85em; }
            .event-indicator { gap: 2px; max-height: 18px;}
            .event-dot { width: 4px; height: 4px; }
            .event-count { font-size: 0.7em; }
    
            /* --- Mobile Year View --- */
            #calendar-year-view {
                 padding: 15px; gap: 15px;
                 grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Slightly larger min width */
            }
            .mini-month { padding: 10px; }
            .mini-month-header { font-size: 0.95em; margin-bottom: 6px;}
            .mini-weekday { font-size: 0.7em;}
            .mini-day { font-size: 0.75em; min-height: 26px; }
             /* Adjust mini date sizes */
            .mini-day .date-en, #calendar-container:not(.nepali-primary) .mini-day .date-en { font-size: 0.9em; }
            .mini-day .date-np, #calendar-container:not(.nepali-primary) .mini-day .date-np { font-size: 0.75em; }
            #calendar-container.nepali-primary .mini-day .date-np { font-size: 0.9em; }
            #calendar-container.nepali-primary .mini-day .date-en { font-size: 0.75em; }
    
            /* --- Mobile Modal --- */
            .modal-content { padding: 20px; }
            .modal-title { font-size: 1.2em; }
            .modal-body form { gap: 12px; }
            .form-group input, .form-group select, .form-group textarea { padding: 9px 11px; font-size: 0.95em; }
            .modal-footer { margin-top: 20px;}
            .modal-button { padding: 9px 18px; font-size: 0.9em; }
        }
         /* --- Add Event Modal --- */
         .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Dim background */
            display: flex;
            /* Default: Center alignment for desktop */
            align-items: center;
            justify-content: center;
            z-index: 1050;
            opacity: 0; visibility: hidden;
            transition: opacity var(--transition-medium), visibility 0s var(--transition-medium);
            padding: 1rem; /* Add padding for spacing around desktop modal */
        }
        .modal-overlay.active { opacity: 1; visibility: visible; transition-delay: 0s; }

        .modal-content {
            background-color: var(--c-bg-container);
            border-radius: 12px;
            box-shadow: var(--shadow-heavy);
            /* Default: Desktop sizing */
            width: 100%; /* Take width from padding */
            max-width: 480px; /* Wider max-width */
            position: relative;
            display: flex; /* Use flex for header/body/footer structure */
            flex-direction: column;
            max-height: 90vh; /* Limit desktop height */
            /* Default: Desktop transform */
            transform: scale(0.95);
            opacity: 0;
            transition: transform var(--transition-medium), opacity var(--transition-medium);
        }
        .modal-overlay.active .modal-content {
             transform: scale(1);
             opacity: 1;
        }

        .modal-header {
             padding: 15px 20px; /* Adjust padding */
             border-bottom: 1px solid var(--c-border);
             display: flex; justify-content: space-between; align-items: center;
             flex-shrink: 0; /* Prevent header shrinking */
         }
        .modal-title { font-size: 1.2em; color: var(--c-primary); } /* Slightly smaller title */
        .modal-close-button { /* Uses .nav-button styles */ flex-shrink: 0; }

        .modal-body {
             padding: 20px; /* Padding for form */
             overflow-y: auto; /* Allow body to scroll if content overflows */
             flex-grow: 1; /* Allow body to take available space */
        }
        .modal-body form { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 0.85em; color: var(--c-text-light); margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid var(--c-border); border-radius: 6px; font-size: 0.95em; font-family: inherit; transition: border-color var(--transition-fast), box-shadow var(--transition-fast); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--c-primary); box-shadow: 0 0 0 2px color-mix(in srgb, var(--c-primary) 20%, transparent); }
        .form-group textarea { min-height: 80px; resize: vertical; }

        .modal-footer {
             padding: 15px 20px; /* Adjust padding */
             border-top: 1px solid var(--c-border);
             text-align: right;
             flex-shrink: 0; /* Prevent footer shrinking */
             background-color: #f8f9fd; /* Subtle background */
             border-radius: 0 0 12px 12px; /* Match bottom corners */
        }
        .modal-button { padding: 10px 20px; border-radius: 6px; font-size: 0.95em; font-weight: 500; transition: background-color var(--transition-fast), color var(--transition-fast); border: none; }
        .modal-button.primary { background-color: var(--c-primary); color: white; }
        .modal-button.primary:hover { background-color: color-mix(in srgb, var(--c-primary) 85%, black); }
        .modal-button.secondary { background-color: #eef1f5; color: var(--c-text-dark); margin-right: 10px; }
        .modal-button.secondary:hover { background-color: #dfe4ea; }

        /* ... other styles ... */

        /* --- Mobile Responsiveness Adjustments --- */
        @media (max-width: 768px) {
             /* ... other mobile styles ... */

            /* --- Mobile Modal: Slide-up Panel --- */
            .modal-overlay {
                 /* Keep overlay as is, but remove padding */
                 padding: 0;
                 /* Remove alignment for centering */
                 align-items: flex-end; /* Align content to bottom */
                 justify-content: unset;
            }
            .modal-content {
                 position: fixed; /* Position relative to viewport */
                 bottom: 0; left: 0; right: 0;
                 width: 100%; /* Full width */
                 max-width: 100%; /* Override desktop max-width */
                 max-height: 85vh; /* Limit height */
                 border-radius: 16px 16px 0 0; /* Rounded top corners */
                 box-shadow: 0 -5px 20px rgba(0,0,0,0.15); /* Shadow on top */
                 /* Animation */
                 transform: translateY(100%); /* Start hidden below */
                 opacity: 1; /* Keep opacity 1 for slide */
                 transition: transform var(--transition-medium) ease-out;
                 margin: 0; /* Remove margin */
            }
            .modal-overlay.active .modal-content {
                 transform: translateY(0); /* Slide up */
            }

            /* Adjust mobile modal padding */
             .modal-header { padding: 12px 15px; }
             .modal-title { font-size: 1.1em; }
             .modal-body { padding: 15px; }
             .modal-footer { padding: 12px 15px; }
             .modal-button { padding: 9px 16px; font-size: 0.9em; }
        }

         /* ... other mobile styles for very small screens etc. ... */

</style>
    
        /* --- Very Small Screens --- */
        @media (max-width: 480px) {
            body { padding: 0.3rem; }
            #calendar-container { margin: 0.3rem auto; }
            .calendar-header { padding: 8px; gap: 8px 10px; }
            #month-year, #year-view-title { font-size: 1.1em; }
            .nav-button { width: 30px; height: 30px; font-size: 0.8em; }
            .view-switcher button, .today-button { padding: 5px 8px; font-size: 0.75em; }
    
            .day { min-height: 60px; padding: 3px; }
            .date-en, #calendar-container:not(.nepali-primary) .date-en { font-size: 1em; }
            .date-np, #calendar-container:not(.nepali-primary) .date-np { font-size: 0.75em; }
            #calendar-container.nepali-primary .date-np { font-size: 1em; }
            #calendar-container.nepali-primary .date-en { font-size: 0.75em; }
    
            #calendar-year-view {
                padding: 10px; gap: 10px;
                grid-template-columns: 1fr; /* Force single column */
            }
             .mini-month { padding: 8px; }
        }
    </style>
</head>
<body>

    <!-- Calendar Integrated into Page -->
    <div id="calendar-container">
        <!-- Header: Controls visibility handled by JS/CSS -->
        <div class="calendar-header">
            <div class="calendar-title">
                <h2 id="month-year" aria-live="polite">Month Year</h2>
                <h2 id="year-view-title" aria-live="polite" style="display: none;">Year</h2>
            </div>
            <div class="header-controls month-controls">
                <button id="today-button" class="today-button">Today</button>
                <button id="prev-month" class="nav-button" aria-label="Previous Month"><i class="fas fa-chevron-left"></i></button>
                <button id="next-month" class="nav-button" aria-label="Next Month"><i class="fas fa-chevron-right"></i></button>
            </div>
             <div class="header-controls year-controls" style="display: none;">
                <button id="today-button-year" class="today-button">Today</button>
                <button id="prev-year" class="nav-button" aria-label="Previous Year"><i class="fas fa-chevron-left"></i></button>
                <button id="next-year" class="nav-button" aria-label="Next Year"><i class="fas fa-chevron-right"></i></button>
             </div>
            <div class="header-controls view-switcher">
                <button id="view-month-button" class="active" data-view="month">Month</button>
                <button id="view-year-button" data-view="year">Year</button>
            </div>
        </div>

        <!-- View Container -->
        <div class="calendar-view-container">
            <!-- Month View Structure -->
            <div id="calendar-month-view">
                <div class="calendar-grid-area">
                     <div class="calendar-config">
                         <label class="toggle-switch" for="nepali-date-toggle">
                             <span>Nepali Dates Primary</span>
                             <input type="checkbox" id="nepali-date-toggle">
                             <span class="slider"></span>
                         </label>
                     </div>
                    <div class="calendar-weekdays">
                        <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
                        <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div>
                        <div class="weekday">Sat</div>
                    </div>
                    <div id="calendar-days" class="calendar-days" role="grid"></div>
                </div>
                <aside id="events-panel" aria-labelledby="event-panel-date">
                    <div class="event-panel-header"><div id="event-panel-date">Select a date</div></div>
                    <div id="event-categories-filter"></div>
                    <ul id="event-panel-list" class="event-panel-list"><li class="no-events">Select a date to see events.</li></ul>
                </aside>
            </div>
            <!-- Year View Structure -->
            <div id="calendar-year-view"></div>
        </div>
    </div>

    <!-- Add Event Button (Floating) -->
     <button id="add-event-button" class="fab" aria-label="Add New Event">
         <i class="fas fa-plus"></i>
     </button>

    <!-- Add Event Modal -->
    <div id="add-event-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="add-event-title">
         <div class="modal-content">
             <div class="modal-header">
                 <h3 id="add-event-title" class="modal-title">Add New Event</h3>
                 <button id="close-modal-button" class="nav-button close-button modal-close-button" aria-label="Close Add Event Form"><i class="fas fa-times"></i></button>
             </div>
             <div class="modal-body"> <form id="add-event-form">
                     <div class="form-group"> <label for="event-name">Event Name *</label> <input type="text" id="event-name" name="eventName" required> </div>
                     <div class="form-group"> <label for="event-category">Category</label> <select id="event-category" name="eventCategory"></select> </div>
                     <div class="form-group"> <label for="event-time">Time (e.g., 14:00 or All Day)</label> <input type="text" id="event-time" name="eventTime" placeholder="HH:MM or All Day"> </div>
                     <div class="form-group"> <label for="event-location">Location</label> <input type="text" id="event-location" name="eventLocation"> </div>
                     <div class="form-group"> <label for="event-description">Description</label> <textarea id="event-description" name="eventDescription"></textarea> </div>
                     <input type="hidden" id="event-date" name="eventDate">
                     <div class="modal-footer"> <button type="button" class="modal-button secondary" id="cancel-modal-button">Cancel</button> <button type="submit" class="modal-button primary">Add Event</button> </div>
             </form> </div>
         </div>
     </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Integrated Calendar V3 script loaded.");

            // --- DOM Elements ---
            const calendarContainer = document.getElementById('calendar-container');
            const monthYearDisplay = document.getElementById('month-year');
            const yearViewTitle = document.getElementById('year-view-title');
            const calendarDaysContainer = document.getElementById('calendar-days');
            const nepaliDateToggle = document.getElementById('nepali-date-toggle');
            const eventsPanel = document.getElementById('events-panel');
            const eventPanelDate = document.getElementById('event-panel-date');
            const eventPanelList = document.getElementById('event-panel-list');
            const eventCategoriesFilter = document.getElementById('event-categories-filter');
            const monthViewContainer = document.getElementById('calendar-month-view');
            const yearViewContainer = document.getElementById('calendar-year-view');
            const viewMonthButton = document.getElementById('view-month-button');
            const viewYearButton = document.getElementById('view-year-button');
            const todayButton = document.getElementById('today-button');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const todayButtonYear = document.getElementById('today-button-year');
            const prevYearBtn = document.getElementById('prev-year');
            const nextYearBtn = document.getElementById('next-year');
            const monthControls = document.querySelector('.month-controls');
            const yearControls = document.querySelector('.year-controls');
            const addEventButton = document.getElementById('add-event-button');
            const addEventModal = document.getElementById('add-event-modal');
            const addEventForm = document.getElementById('add-event-form');
            const closeModalButton = document.getElementById('close-modal-button');
            const cancelModalButton = document.getElementById('cancel-modal-button');
            const eventCategorySelect = document.getElementById('event-category');
            const eventDateInput = document.getElementById('event-date');

            // --- State ---
            const today = new Date(); today.setHours(0,0,0,0);
            let currentMonth = today.getMonth();
            let currentYear = today.getFullYear();
            let currentView = 'month'; // Start with month view
            let showNepaliDatesPrimary = false; // Default to English primary
            let selectedDate = null;
            let selectedCategories = new Set();
            let isMobileView = window.innerWidth < 768;
            const localStorageKey = 'khojumCalendarEvents';

            // --- Data & Config ---
            let eventsData = {}; // Initialize empty, load from storage
            const holidays = { /* ... Keep existing holidays ... */
                nepali: { '2081-01-01': 'Nepali New Year', '2081-07-03': 'Dashain (Phulpati)', '2081-07-21': 'Tihar (Laxmi Puja)', },
                english: { '2024-01-01': 'New Year\'s Day', '2024-12-25': 'Christmas Day', '2024-07-04': 'Independence Day (US)' }
             };
             const categoryConfig = { /* ... Keep existing categoryConfig ... */
                'entertainment': { color: '#ff7f50', icon: 'ðŸŽµ' }, 'education': { color: '#4682b4', icon: 'ðŸ“š' },
                'culture': { color: '#9370db', icon: 'ðŸŽ¨' }, 'holiday': { color: '#2ecc71', icon: 'ðŸŽ‰' },
                'promotion': { color: '#f1c40f', icon: 'ðŸ’°' }, 'work': { color: '#3498db', icon: 'ðŸ’¼' },
                'health': { color: '#1abc9c', icon: 'â¤ï¸' }, 'personal': { color: '#e74c3c', icon: 'ðŸ‘¤' },
                'meeting': { color: '#8e44ad', icon: 'ðŸ—£ï¸' }, 'default': { color: '#95a5a6', icon: 'ðŸ“…' }
            };
             const nepaliDaysInMonth = { /* ... Keep existing data ... */
                 2080: [30, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30], 2081: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 29, 30],
                 2082: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2083: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 30],
             };
             const nepaliMonths = [ 'à¤¬à¥ˆà¤¶à¤¾à¤–', 'à¤œà¥‡à¤ ', 'à¤…à¤¸à¤¾à¤°', 'à¤¶à¥à¤°à¤¾à¤µà¤£', 'à¤­à¤¦à¥Œ', 'à¤…à¤¸à¥‹à¤œ', 'à¤•à¤¾à¤°à¥à¤¤à¤¿à¤•', 'à¤®à¤‚à¤¸à¤¿à¤°', 'à¤ªà¥à¤·', 'à¤®à¤¾à¤˜', 'à¤«à¤¾à¤—à¥à¤¨', 'à¤šà¥ˆà¤¤' ];
             const englishMonths = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
             const nepaliDigits = ['à¥¦', 'à¥§', 'à¥¨', 'à¥©', 'à¥ª', 'à¥«', 'à¥¬', 'à¥­', 'à¥®', 'à¥¯'];

            // --- Local Storage Functions ---
            function saveEventsToLocalStorage() {
                try {
                    localStorage.setItem(localStorageKey, JSON.stringify(eventsData));
                    console.log("Events saved to localStorage.");
                } catch (e) {
                    console.error("Error saving events to localStorage:", e);
                }
            }

            function loadEventsFromLocalStorage() {
                try {
                    const storedEvents = localStorage.getItem(localStorageKey);
                    if (storedEvents) {
                        eventsData = JSON.parse(storedEvents);
                        console.log("Events loaded from localStorage.");
                    } else {
                        // Use default sample data if nothing in storage
                        eventsData = { /* Paste your default eventsData here if desired */
                             '2024-07-25': [ { id: 1, name: 'Sample Event', category: 'work', time: '10:00', location: 'Office', description: 'This is loaded from default if storage is empty.' } ],
                             [(new Date().toISOString().split('T')[0])] : [ { id: 101, name: 'Today\'s Default Event', category: 'personal', time: 'Anytime', location: '', description: '' }]
                        };
                        console.log("No events found in localStorage, using default/empty.");
                    }
                } catch (e) {
                    console.error("Error loading or parsing events from localStorage:", e);
                    eventsData = {}; // Fallback to empty if parsing fails
                }
            }

            // --- Helper Functions (Keep existing: toNepaliDigits, getNepaliDetails, isHoliday, getHolidayName, formatDateKey) ---
            function toNepaliDigits(num) { return num.toString().split('').map(d => nepaliDigits[parseInt(d)] || d).join(''); }
            function getNepaliDetails(targetDate) { /* ... Keep existing robust logic ... */
                if (!(targetDate instanceof Date) || isNaN(targetDate)) { return { year: 0, month: 0, day: 0, monthName: 'Invalid', dayNepali: 'à¥¦', yearNepali: 'à¥¦' }; }
                const year = targetDate.getFullYear(); const month = targetDate.getMonth(); const day = targetDate.getDate();
                const referenceEnglishDate = new Date(2024, 0, 1); const referenceNepaliYear = 2080; const referenceNepaliMonth = 8; const referenceNepaliDay = 16;
                function checkYearData(yr) { if (!nepaliDaysInMonth[yr]) { console.warn(`Nepali month data missing for year ${yr}. Using fallback.`); return nepaliDaysInMonth[2081] || nepaliDaysInMonth[Object.keys(nepaliDaysInMonth)[0]]; } return nepaliDaysInMonth[yr]; }
                const millisecondsPerDay = 86400000; const targetUTC = Date.UTC(year, month, day); const referenceUTC = Date.UTC(referenceEnglishDate.getFullYear(), referenceEnglishDate.getMonth(), referenceEnglishDate.getDate()); const daysDifference = Math.round((targetUTC - referenceUTC) / millisecondsPerDay);
                let nepaliYear = referenceNepaliYear; let nepaliMonth = referenceNepaliMonth; let nepaliDay = referenceNepaliDay; let currentYearData = checkYearData(nepaliYear); let remainingDays = daysDifference;
                if (remainingDays >= 0) { while (remainingDays > 0) { const daysInCurrentMonth = currentYearData[nepaliMonth]; if (!daysInCurrentMonth) { console.error(`Missing days for BS ${nepaliYear}, Month ${nepaliMonth}`); break; } const daysLeftInMonth = daysInCurrentMonth - nepaliDay; if (remainingDays <= daysLeftInMonth) { nepaliDay += remainingDays; remainingDays = 0; } else { remainingDays -= (daysLeftInMonth + 1); nepaliDay = 1; nepaliMonth++; if (nepaliMonth > 11) { nepaliMonth = 0; nepaliYear++; currentYearData = checkYearData(nepaliYear); } } }
                } else { remainingDays = Math.abs(remainingDays); while (remainingDays > 0) { const daysToSubtract = nepaliDay - 1; if (remainingDays <= daysToSubtract) { nepaliDay -= remainingDays; remainingDays = 0; } else { remainingDays -= (daysToSubtract + 1); nepaliMonth--; if (nepaliMonth < 0) { nepaliMonth = 11; nepaliYear--; currentYearData = checkYearData(nepaliYear); } nepaliDay = currentYearData[nepaliMonth]; if (!nepaliDay) { console.error(`Missing days for BS ${nepaliYear}, Month ${nepaliMonth}`); break; } } } }
                return { year: nepaliYear, month: nepaliMonth, day: nepaliDay, monthName: nepaliMonths[nepaliMonth], dayNepali: toNepaliDigits(nepaliDay), yearNepali: toNepaliDigits(nepaliYear) };
             }
            function getEventsForDate(date) { const dateString = formatDateKey(date); return eventsData[dateString] || []; }
            function formatDateKey(date) { if (!(date instanceof Date) || isNaN(date)) return ''; return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
             function isHoliday(date) { const dateKeyEn = formatDateKey(date); if (holidays.english[dateKeyEn]) return true; const nepaliDate = getNepaliDetails(date); const dateKeyNp = `${nepaliDate.year}-${String(nepaliDate.month + 1).padStart(2, '0')}-${String(nepaliDate.day).padStart(2, '0')}`; return !!holidays.nepali[dateKeyNp]; }
             function getHolidayName(date) { const dateKeyEn = formatDateKey(date); if (holidays.english[dateKeyEn]) return holidays.english[dateKeyEn]; const nepaliDate = getNepaliDetails(date); const dateKeyNp = `${nepaliDate.year}-${String(nepaliDate.month + 1).padStart(2, '0')}-${String(nepaliDate.day).padStart(2, '0')}`; return holidays.nepali[dateKeyNp] || ''; }

            // --- View Rendering ---
            function renderCurrentView() {
                 calendarContainer.classList.toggle('view-month', currentView === 'month');
                 calendarContainer.classList.toggle('view-year', currentView === 'year');

                 if (currentView === 'month') {
                     renderCalendar(currentMonth, currentYear);
                     updateEventsPanel(selectedDate); // Update panel based on current selection
                 } else {
                     renderYearView(currentYear);
                     updateEventsPanel(null); // Clear/hide panel in year view
                 }
                 updateHeader();
                 handleResize(); // Ensure layout constraints are applied
            }

            function updateHeader() {
                 if (currentView === 'month') {
                    const nepaliHeaderDate = getNepaliDetails(new Date(currentYear, currentMonth, 1));
                    monthYearDisplay.textContent = `${englishMonths[currentMonth]} ${currentYear} / ${nepaliHeaderDate.monthName} ${nepaliHeaderDate.yearNepali}`;
                    monthYearDisplay.style.display = 'block';
                    yearViewTitle.style.display = 'none';
                    monthControls.style.display = 'flex';
                    yearControls.style.display = 'none';
                    viewMonthButton.classList.add('active');
                    viewYearButton.classList.remove('active');
                 } else { // Year view
                    const nepaliYearNum = getNepaliDetails(new Date(currentYear, 0, 1)).year;
                    const nepaliYearText = toNepaliDigits(nepaliYearNum);
                    yearViewTitle.textContent = `${currentYear} / ${nepaliYearText}`;
                    monthYearDisplay.style.display = 'none';
                    yearViewTitle.style.display = 'block';
                    monthControls.style.display = 'none';
                    yearControls.style.display = 'flex';
                    viewMonthButton.classList.remove('active');
                    viewYearButton.classList.add('active');
                 }
                 // Update Nepali emphasis class based on toggle state
                 calendarContainer.classList.toggle('nepali-primary', showNepaliDatesPrimary);
            }

            // --- Month View Rendering ---
            function renderCalendar(month, year) { /* ... Keep existing logic ... */
                console.log(`Rendering Month: ${year}-${month + 1}`);
                const fragment = document.createDocumentFragment();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();
                for (let i = firstDayOfMonth - 1; i >= 0; i--) { fragment.appendChild(createDayElement(year, month - 1, daysInPrevMonth - i, true)); }
                for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) { const dayElement = createDayElement(year, month, dayNum, false); const currentDate = new Date(year, month, dayNum); currentDate.setHours(0, 0, 0, 0); if (currentDate.getTime() === today.getTime()) { dayElement.classList.add('today'); } if (selectedDate && currentDate.getTime() === selectedDate.getTime()) { dayElement.classList.add('selected'); } if (isHoliday(currentDate)) { dayElement.classList.add('holiday'); dayElement.setAttribute('title', getHolidayName(currentDate)); } addEventIndicators(dayElement, currentDate); dayElement.addEventListener('click', () => handleDateClick(dayElement, currentDate)); fragment.appendChild(dayElement); }
                 const totalDaysRendered = firstDayOfMonth + daysInMonth; const nextMonthDaysToAdd = (7 - (totalDaysRendered % 7)) % 7; for (let i = 1; i <= nextMonthDaysToAdd; i++) { fragment.appendChild(createDayElement(year, month + 1, i, true)); }
                calendarDaysContainer.innerHTML = ''; calendarDaysContainer.appendChild(fragment);
                 calendarDaysContainer.classList.remove('fade-in'); void calendarDaysContainer.offsetWidth; calendarDaysContainer.classList.add('fade-in');
            }
             function createDayElement(year, month, dayNum, isInactive) { /* ... Keep existing logic ... */
                 const dayElement = document.createElement('div'); dayElement.classList.add('day'); if (isInactive) dayElement.classList.add('inactive'); const currentDate = new Date(year, month, dayNum); const dateString = formatDateKey(currentDate); dayElement.dataset.date = dateString; const nepDate = getNepaliDetails(currentDate);
                 dayElement.innerHTML = `<div class="day-dates"><span class="date-en">${dayNum}</span><span class="date-np">${nepDate.dayNepali}</span></div><div class="event-indicator"></div>`;
                 return dayElement;
             }
             function addEventIndicators(dayElement, date) { /* ... Keep existing logic ... */
                 const events = getEventsForDate(date); const indicatorContainer = dayElement.querySelector('.event-indicator'); if (events.length > 0 && indicatorContainer) { dayElement.classList.add('has-events'); const maxDots = isMobileView ? 3 : 4; const uniqueCategories = [...new Set(events.map(e => e.category || 'default'))]; let dotCount = 0; uniqueCategories.slice(0, maxDots).forEach(category => { const dot = document.createElement('span'); dot.classList.add('event-dot'); dot.style.backgroundColor = categoryConfig[category]?.color || categoryConfig.default.color; indicatorContainer.appendChild(dot); dotCount++; }); const remainingEvents = events.length - dotCount; const remainingCategories = uniqueCategories.length - dotCount; if (events.length > maxDots) { const countBadge = document.createElement('span'); countBadge.classList.add('event-count'); countBadge.textContent = (remainingCategories <= 0) ? `+${remainingEvents}` : '+'; indicatorContainer.appendChild(countBadge); } }
             }

            // --- Year View Rendering ---
             function renderYearView(year) { /* ... Keep existing logic ... */
                 console.log(`Rendering Year: ${year}`);
                 yearViewContainer.innerHTML = ''; const fragment = document.createDocumentFragment();
                 for (let month = 0; month < 12; month++) { fragment.appendChild(renderMiniMonth(year, month)); }
                 yearViewContainer.appendChild(fragment);
             }
             function renderMiniMonth(year, month) { /* ... Keep existing logic, added click listener ... */
                 const miniMonthDiv = document.createElement('div'); miniMonthDiv.classList.add('mini-month'); const monthName = englishMonths[month]; const nepaliMonthName = getNepaliDetails(new Date(year, month, 1)).monthName;
                 const header = document.createElement('div'); header.classList.add('mini-month-header'); header.textContent = `${monthName} / ${nepaliMonthName}`; miniMonthDiv.appendChild(header);
                 const weekdaysDiv = document.createElement('div'); weekdaysDiv.classList.add('mini-calendar-weekdays'); ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => { const weekday = document.createElement('div'); weekday.classList.add('mini-weekday'); weekday.textContent = day; weekdaysDiv.appendChild(weekday); }); miniMonthDiv.appendChild(weekdaysDiv);
                 const daysDiv = document.createElement('div'); daysDiv.classList.add('mini-calendar-days'); const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
                 for (let i = 0; i < firstDayOfMonth; i++) { const dayElement = document.createElement('div'); dayElement.classList.add('mini-day', 'inactive'); daysDiv.appendChild(dayElement); }
                 for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) { const dayElement = document.createElement('div'); dayElement.classList.add('mini-day'); const currentDate = new Date(year, month, dayNum); currentDate.setHours(0,0,0,0); const nepDate = getNepaliDetails(currentDate); dayElement.innerHTML = `<span class="date-en">${dayNum}</span><span class="date-np">${nepDate.dayNepali}</span>`; if (currentDate.getTime() === today.getTime()) { dayElement.classList.add('today'); } if (isHoliday(currentDate)) { dayElement.classList.add('holiday'); }
                    dayElement.addEventListener('click', () => { // Go to this month/date in Month view
                         currentMonth = month; currentYear = year; selectedDate = currentDate; switchView('month');
                     });
                    daysDiv.appendChild(dayElement);
                 } miniMonthDiv.appendChild(daysDiv); return miniMonthDiv;
             }

            // --- Event Handling & UI Updates ---
            function handleDateClick(dayElement, date) { /* ... Keep existing logic ... */
                 console.log("Month View Date clicked:", date.toDateString());
                 const previouslySelected = calendarDaysContainer.querySelector('.day.selected'); if (previouslySelected) previouslySelected.classList.remove('selected');
                 dayElement.classList.add('selected'); selectedDate = date;
                 updateEventsPanel(date);
            }
            function updateEventsPanel(date) { /* ... Keep existing logic, ensures clearing in year view ... */
                 if (!date || currentView === 'year' || !eventsPanel) {
                     if(eventPanelDate) eventPanelDate.innerHTML = currentView === 'year' ? 'Year View' : 'Select a date';
                     if(eventPanelList) eventPanelList.innerHTML = `<li class="no-events">${currentView === 'year' ? 'Select a month to switch view.' : 'Select a date to see events.'}</li>`;
                     if(eventPanelDate) { const existingBadge = eventPanelDate.querySelector('.holiday-badge'); if(existingBadge) existingBadge.remove(); }
                     return;
                 }
                 const events = getEventsForDate(date); const nepaliDate = getNepaliDetails(date); const holidayName = getHolidayName(date); const dateKey = formatDateKey(date);
                 eventPanelDate.innerHTML = `${date.toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' })}<span class="sub-date">${nepaliDate.monthName} ${nepaliDate.dayNepali}, ${nepaliDate.yearNepali}</span>`;
                 const existingBadge = eventPanelDate.querySelector('.holiday-badge'); if(existingBadge) existingBadge.remove(); if (holidayName) { const badge = document.createElement('div'); badge.className = 'holiday-badge'; badge.textContent = holidayName; eventPanelDate.appendChild(badge); }
                 if (!eventCategoriesFilter.hasChildNodes()) { updateCategoryFilters(eventsData); }
                 const filteredEvents = selectedCategories.size > 0 ? events.filter(event => selectedCategories.has(event.category || 'default')) : events;
                 eventPanelList.innerHTML = ''; if (filteredEvents.length > 0) { filteredEvents.sort((a, b) => { const timeA = a.time || ''; const timeB = b.time || ''; if (timeA === 'All Day') return -1; if (timeB === 'All Day') return 1; return timeA.localeCompare(timeB); }); filteredEvents.forEach(event => { const li = createEventItemElement(event, date); eventPanelList.appendChild(li); }); } else { const li = document.createElement('li'); li.classList.add('no-events'); li.textContent = selectedCategories.size > 0 ? 'No events match filters.' : 'No events scheduled.'; eventPanelList.appendChild(li); }
                 if (eventDateInput) { eventDateInput.value = dateKey; }
            }
            function createEventItemElement(event, date) { /* ... Keep existing logic ... */
                 const li = document.createElement('li'); li.classList.add('event-item'); li.dataset.eventId = event.id; const category = event.category || 'default'; const categoryInfo = categoryConfig[category] || categoryConfig.default;
                 li.innerHTML = `<div class="event-card" style="border-left-color: ${categoryInfo.color}"><div class="event-content-wrapper"><div class="event-header"><span class="event-icon" aria-hidden="true">${categoryInfo.icon}</span><span class="event-name">${event.name || 'Untitled Event'}</span></div><div class="event-details">${event.time ? `<span class="event-time">${event.time}</span>` : ''}${event.location ? `<span class="event-location">${event.location}</span>` : ''}</div> ${event.description ? `<div class="event-description">${event.description}</div>` : ''}</div><button class="delete-event" aria-label="Delete event: ${event.name}">Ã—</button></div>`;
                 li.querySelector('.delete-event')?.addEventListener('click', (e) => { e.stopPropagation(); deleteEvent(date, event.id); });
                 li.querySelector('.event-card')?.addEventListener('click', (e) => { e.currentTarget.classList.add('highlight'); setTimeout(() => e.currentTarget.classList.remove('highlight'), 500); console.log("Clicked event:", event.name); });
                 return li;
            }
            function deleteEvent(date, eventId) { /* ... Keep existing logic, added save ... */
                 const dateString = formatDateKey(date); if (eventsData[dateString]) { const initialLength = eventsData[dateString].length; eventsData[dateString] = eventsData[dateString].filter(event => event.id !== eventId); if (eventsData[dateString].length === 0) { delete eventsData[dateString]; } if (eventsData[dateString]?.length !== initialLength) { console.log(`Deleted event ${eventId} on ${dateString}`); saveEventsToLocalStorage(); if (currentView === 'month') updateEventsPanel(date); renderCurrentView(); updateCategoryFilters(eventsData); } }
            }
             function addEvent(eventDetails) { /* ... Keep existing logic, added save ... */
                const dateString = eventDetails.date; if (!dateString) { console.error("Cannot add event: Date is missing."); return; } if (!eventsData[dateString]) { eventsData[dateString] = []; } const newId = Date.now() + Math.floor(Math.random() * 1000); const newEvent = { id: newId, name: eventDetails.name || 'Untitled Event', category: eventDetails.category || 'default', time: eventDetails.time || '', location: eventDetails.location || '', description: eventDetails.description || '' }; eventsData[dateString].push(newEvent); console.log("Added event:", newEvent); saveEventsToLocalStorage();
                const eventDateObj = new Date(dateString + 'T00:00:00'); if (selectedDate && formatDateKey(selectedDate) === dateString && currentView === 'month') { updateEventsPanel(selectedDate); } renderCurrentView(); updateCategoryFilters(eventsData);
             }
            function updateCategoryFilters(allEventsData) { /* ... Keep existing logic ... */
                 if (!eventCategoriesFilter || !eventCategorySelect) return; const allCategories = new Set(); Object.values(allEventsData).flat().forEach(event => allCategories.add(event.category || 'default')); eventCategoriesFilter.innerHTML = ''; const sortedCategories = ['all', ...[...allCategories].sort()]; sortedCategories.forEach(category => { const categoryInfo = categoryConfig[category] || categoryConfig.default; const filterOption = document.createElement('button'); filterOption.classList.add('category-filter'); filterOption.dataset.category = category; if (category === 'all') { filterOption.innerHTML = `<span class="category-name">All</span>`; } else { filterOption.innerHTML = `<span class="category-dot" style="background-color: ${categoryInfo.color}"></span><span class="category-name">${category.charAt(0).toUpperCase() + category.slice(1)}</span>`; } if ((category === 'all' && selectedCategories.size === 0) || selectedCategories.has(category)) { filterOption.classList.add('selected'); } filterOption.addEventListener('click', () => handleCategoryFilterClick(category)); eventCategoriesFilter.appendChild(filterOption); }); eventCategorySelect.innerHTML = ''; [...allCategories].sort().forEach(category => { if (category === 'default') return; const option = document.createElement('option'); option.value = category; option.textContent = category.charAt(0).toUpperCase() + category.slice(1); eventCategorySelect.appendChild(option); }); const defaultOption = document.createElement('option'); defaultOption.value = 'default'; defaultOption.textContent = 'Default'; eventCategorySelect.insertBefore(defaultOption, eventCategorySelect.firstChild);
             }
             function handleCategoryFilterClick(clickedCategory) { /* ... Keep existing logic ... */
                 const allButton = eventCategoriesFilter.querySelector('[data-category="all"]'); if (clickedCategory === 'all') { selectedCategories.clear(); } else { if (selectedCategories.has(clickedCategory)) { selectedCategories.delete(clickedCategory); } else { selectedCategories.add(clickedCategory); } } document.querySelectorAll('#event-categories-filter .category-filter').forEach(btn => { const category = btn.dataset.category; if (category === 'all') { btn.classList.toggle('selected', selectedCategories.size === 0); } else { btn.classList.toggle('selected', selectedCategories.has(category)); } }); if (selectedCategories.size > 0) { allButton?.classList.remove('selected'); } if (selectedDate && currentView === 'month') { updateEventsPanel(selectedDate); }
             }
            function changeMonth(offset) { /* ... Keep existing logic ... */
                 if (currentView !== 'month') return; calendarDaysContainer.classList.add('fade-out'); setTimeout(() => { currentMonth += offset; if (currentMonth < 0) { currentMonth = 11; currentYear--; } else if (currentMonth > 11) { currentMonth = 0; currentYear++; } selectedDate = null; renderCurrentView(); calendarDaysContainer.classList.remove('fade-out'); }, 150);
            }
             function changeYear(offset) { /* ... Keep existing logic ... */
                 if (currentView !== 'year') return; currentYear += offset; renderCurrentView();
             }
             function goToToday() { /* ... Keep existing logic ... */
                 currentYear = today.getFullYear(); currentMonth = today.getMonth(); selectedDate = today; renderCurrentView();
             }
             function switchView(view) { /* ... Keep existing logic ... */
                 if (view === currentView) return; currentView = view; renderCurrentView();
             }
             function handleResize() { /* ... Keep existing logic ... */
                 const currentlyMobile = window.innerWidth < 768; if (currentlyMobile !== isMobileView) { isMobileView = currentlyMobile; calendarContainer.classList.toggle('mobile-view', isMobileView); console.log("View changed. isMobileView:", isMobileView); renderCurrentView(); }
             }
             function toggleModal(modalElement, forceShow = null) { /* ... Keep existing logic ... */
                 if (!modalElement) return; const isActive = modalElement.classList.contains('active'); const show = forceShow !== null ? forceShow : !isActive; if (show) { modalElement.classList.add('active'); modalElement.setAttribute('aria-hidden', 'false'); if (modalElement === addEventModal) { addEventForm.querySelector('input, select, textarea')?.focus(); } } else { modalElement.classList.remove('active'); modalElement.setAttribute('aria-hidden', 'true'); }
             }

            // --- Event Listeners ---
            viewMonthButton.addEventListener('click', () => switchView('month'));
            viewYearButton.addEventListener('click', () => switchView('year'));
            todayButton.addEventListener('click', goToToday); // Month view today
            todayButtonYear.addEventListener('click', goToToday); // Year view today
            prevMonthBtn.addEventListener('click', () => changeMonth(-1));
            nextMonthBtn.addEventListener('click', () => changeMonth(1));
            prevYearBtn.addEventListener('click', () => changeYear(-1));
            nextYearBtn.addEventListener('click', () => changeYear(1));
            nepaliDateToggle.addEventListener('change', (event) => {
                showNepaliDatesPrimary = event.target.checked;
                console.log("Nepali Dates Primary:", showNepaliDatesPrimary);
                calendarContainer.classList.toggle('nepali-primary', showNepaliDatesPrimary);
                // Re-rendering might be needed if mini-month layout relies on primary date size in JS, but CSS handles visuals
                 // renderCurrentView(); // Optional: Re-render if JS logic depends on this state
            });

            // Modal Listeners
            addEventButton?.addEventListener('click', () => {
                 let targetDateForModal = selectedDate;
                 if (currentView === 'year') {
                     alert("Switch to Month view to select a specific date for the event."); return;
                 }
                 if (!targetDateForModal) {
                      targetDateForModal = today; // Default to today if no date selected
                      alert("No date selected, defaulting to today for the new event."); // Inform user
                      selectedDate = today; // Also select today visually
                      renderCurrentView(); // Update visual selection
                 }
                 addEventForm.reset();
                 eventDateInput.value = formatDateKey(targetDateForModal);
                 toggleModal(addEventModal, true);
             });
            closeModalButton?.addEventListener('click', () => toggleModal(addEventModal, false));
            cancelModalButton?.addEventListener('click', () => toggleModal(addEventModal, false));
            addEventModal?.addEventListener('click', (event) => { if (event.target === addEventModal) toggleModal(addEventModal, false); });
            addEventForm?.addEventListener('submit', (event) => { /* ... Keep existing logic ... */
                event.preventDefault(); const formData = new FormData(addEventForm); const eventDetails = { date: formData.get('eventDate'), name: formData.get('eventName'), category: formData.get('eventCategory'), time: formData.get('eventTime'), location: formData.get('eventLocation'), description: formData.get('eventDescription') }; addEvent(eventDetails); toggleModal(addEventModal, false);
             });
            document.addEventListener('keydown', (event) => { if (event.key === 'Escape') { if (addEventModal?.classList.contains('active')) { toggleModal(addEventModal, false); } } });
            window.addEventListener('resize', handleResize);

            // --- Initial Setup ---
            loadEventsFromLocalStorage(); // Load events first
            handleResize(); // Set mobile/desktop state
            updateCategoryFilters(eventsData); // Populate filters
            goToToday(); // Start at today's date in month view (this calls renderCurrentView)

            console.log("Integrated calendar V3 initialized.");
        }); // End DOMContentLoaded
    </script>

</body>
</html>
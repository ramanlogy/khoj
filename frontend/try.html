<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Nepali/English Calendar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Base & Variables --- */
        :root {
            --primary-color: #6a1b9a; /* Purple */
            --secondary-color: #ab47bc; /* Lighter Purple */
            --accent-color: #ff4081; /* Pink Accent */
            --text-color: #333;
            --text-muted: #777;
            --bg-color: #f8f9fa;
            --panel-bg: #ffffff;
            --border-color: #e0e0e0;
            --today-bg: var(--primary-color);
            --selected-bg: rgba(171, 71, 188, 0.2); /* Light purple selection */
            --holiday-color: #2e8b57; /* Green */
            --event-dot-size: 5px; /* Slightly smaller default */
            --mobile-event-dot-size: 4px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            background-color: #eef1f5; /* Light grey background */
            color: var(--text-color);
            line-height: 1.5;
            font-size: 16px; /* Base size for mobile */
        }
        button { cursor: pointer; border: none; background: none; padding: 0; }
        ul { list-style: none; padding: 0; margin: 0; }

        /* --- Calendar Icon Trigger --- */
        #calendar-icon-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
        }
        #calendar-icon {
            background-color: var(--primary-color);
            color: white;
            width: 50px; /* Slightly smaller */
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-out;
        }
        #calendar-icon:hover { transform: scale(1.1); }

        /* --- Calendar Popup (Mobile First) --- */
        .calendar-popup {
            position: fixed;
            /* Mobile: Take most of the screen */
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 95vw;
            max-width: 500px; /* Max width on mobile */
            height: 90vh;
            background-color: var(--panel-bg);
            border-radius: 10px; /* Subtle radius for mobile */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column; /* Stack calendar and events on mobile */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s;
            z-index: 1000;
            overflow: hidden; /* Prevent content spill */
        }
        .calendar-popup.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
            transition-delay: 0s;
        }

        /* --- Calendar Main Area (Mobile First) --- */
        .calendar-main {
            /* Mobile: Take upper part, allow shrinking if events panel is large */
            flex-shrink: 1;
            display: flex;
            flex-direction: column;
            height: 60%; /* Default height, adjusts based on event panel */
            min-height: 280px; /* Ensure calendar doesn't get too small */
            border-bottom: 1px solid var(--border-color);
            overflow: hidden; /* Hide potential overflow within main section */
        }

        /* --- Header --- */
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px; /* Reduced padding for mobile */
            border-bottom: 1px solid var(--border-color);
            background-color: #fdfdff;
            flex-shrink: 0; /* Prevent header shrinking */
        }
        #month-year {
            font-size: 1.1em; /* Reduced for mobile */
            font-weight: 600;
            color: var(--primary-color);
            text-align: center;
            flex-grow: 1;
            margin: 0 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .nav-button {
            color: var(--secondary-color);
            font-size: 1.2em; /* Adequate tap size */
            padding: 8px; /* Tap area */
            border-radius: 4px;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .nav-button:hover { background-color: rgba(0, 0, 0, 0.05); }
        .close-button { color: var(--text-muted); }

        /* --- Toggle & Config Area --- */
        .calendar-config {
            display: flex;
            justify-content: flex-end; /* Align toggle right */
            padding: 6px 15px; /* Reduced padding */
            border-bottom: 1px solid var(--border-color);
            background-color: #fdfdff;
            font-size: 0.8em; /* Reduced size */
            flex-shrink: 0; /* Prevent shrinking */
        }
        .toggle-switch { display: flex; align-items: center; cursor: pointer; }
        .toggle-switch input { display: none; }
        .toggle-switch .slider {
            width: 34px; height: 18px; background-color: #ccc;
            border-radius: 18px; position: relative; transition: background-color 0.3s;
            margin-left: 8px;
        }
        .toggle-switch .slider::before {
            content: ""; position: absolute;
            height: 12px; width: 12px; left: 3px; bottom: 3px;
            background-color: white; border-radius: 50%; transition: transform 0.3s;
        }
        .toggle-switch input:checked + .slider { background-color: var(--secondary-color); }
        .toggle-switch input:checked + .slider::before { transform: translateX(16px); }

        /* --- Weekdays --- */
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            padding: 6px 5px; /* Reduced padding */
            background-color: #f8f9fc;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; /* Prevent shrinking */
        }
        .weekday {
            text-align: center;
            font-weight: 600;
            font-size: 0.75em; /* Reduced size */
            color: var(--text-muted);
        }

        /* --- Days Grid --- */
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px; /* Subtle grid lines */
            background-color: var(--border-color); /* Grid line color */
            flex-grow: 1; /* Takes remaining space in calendar-main */
            overflow-y: auto; /* Scroll if needed */
            padding: 1px; /* Offset gap */
            transition: opacity 0.2s ease-out; /* Only fade for month change */
        }
        .calendar-days.fade-out { opacity: 0; } /* For month change */
        .calendar-days.fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Day Cell --- */
        .day {
            background-color: var(--panel-bg);
            padding: 4px; /* Reduced padding */
            box-sizing: border-box;
            text-align: right;
            position: relative;
            min-height: 60px; /* Reduced min height */
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            font-size: 0.8em; /* Reduced size */
        }
        .day:hover:not(.inactive) { background-color: #f1f3f8; }
        .day.inactive { background-color: #f8f9fa; color: #bbb; cursor: default; }

        /* Date Display */
        .day-dates { line-height: 1.2; margin-bottom: auto; }
        .eng-date, .nepali-date { display: block; transition: font-size 0.2s, color 0.2s; }
        .eng-date { font-size: 1em; font-weight: 500; color: var(--text-color); }
        .nepali-date { font-size: 0.75em; color: var(--text-muted); }
        .calendar-days.nepali-visible .nepali-date { font-size: 1em; font-weight: 500; color: var(--text-color); }
        .calendar-days.nepali-visible .eng-date { font-size: 0.75em; color: var(--text-muted); }
        .day.inactive .eng-date, .day.inactive .nepali-date { color: #ccc; }

        /* Today & Selected Styles */
        .day.today { background-color: var(--today-bg); color: white; border-radius: 3px; } /* Smaller radius */
        .day.today .eng-date, .day.today .nepali-date { color: white; }
        .day.today .eng-date { font-weight: bold; }
        .calendar-days.nepali-visible .day.today .nepali-date { font-weight: bold; }
        .calendar-days.nepali-visible .day.today .eng-date { font-weight: normal; color: rgba(255, 255, 255, 0.8); }
        .day.selected { background-color: var(--selected-bg); box-shadow: inset 0 0 0 2px var(--secondary-color); border-radius: 3px; }

        /* Holiday Indicator */
        .day.holiday .eng-date, .calendar-days.nepali-visible .day.holiday .nepali-date {
            color: var(--holiday-color); font-weight: bold;
        }
        .holiday-dot { /* Optional dot */
            position: absolute; top: 3px; left: 3px;
            width: var(--mobile-event-dot-size); height: var(--mobile-event-dot-size);
            background-color: var(--holiday-color); border-radius: 50%;
        }

        /* Event Indicator Area */
        .event-indicator {
            display: flex; flex-wrap: wrap; gap: 2px;
            justify-content: flex-start;
            position: absolute; bottom: 3px; left: 3px; right: 3px;
        }
        .event-dot {
            width: var(--mobile-event-dot-size); height: var(--mobile-event-dot-size);
            border-radius: 50%; flex-shrink: 0;
        }
        .event-count {
            font-size: 0.7em; font-weight: bold; color: var(--text-muted);
            margin-left: auto; background: rgba(0,0,0,0.05); padding: 0 3px; border-radius: 3px;
            line-height: 1; /* Ensure small height */
        }

        /* --- Events Panel (Mobile First) --- */
        .events-panel {
            /* Mobile: Positioned absolutely at the bottom, slides up */
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            height: 40%; /* Default height, can adjust */
            background-color: var(--panel-bg);
            display: flex;
            flex-direction: column;
            transform: translateY(100%); /* Hidden below */
            opacity: 1; visibility: visible; /* Always visible structurally, transform hides */
            transition: transform 0.3s ease-out;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            border-radius: 10px 10px 0 0; /* Rounded top corners */
            overflow: hidden;
        }
        .events-panel.mobile-visible {
            transform: translateY(0); /* Slide up */
        }
        .events-panel.active { /* This class might not be needed if mobile-visible controls it */ }

        .event-panel-header {
            padding: 10px 15px; /* Reduced padding */
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; /* Prevent shrinking */
            position: relative; /* For close button positioning */
        }
        #event-panel-date { font-weight: 600; font-size: 1em; margin-bottom: 3px; }
        #event-panel-date .sub-date { font-size: 0.75em; color: var(--text-muted); display: block; margin-top: 1px; }
        .holiday-badge {
            display: inline-block; background-color: var(--holiday-color); color: white;
            padding: 1px 6px; border-radius: 10px; font-size: 0.7em; font-weight: 500;
            margin-top: 4px;
        }
        /* Mobile Close Button for Events Panel */
        #close-events {
            position: absolute;
            top: 5px; right: 5px; /* Position top right */
            color: var(--text-muted);
            font-size: 1.2em;
            padding: 5px;
            display: none; /* Hidden by default, shown via JS for mobile */
            z-index: 10; /* Above other header content */
        }
        .mobile-view #close-events {
             display: flex; /* Show only when mobile-view class is present */
        }


        /* Category Filters */
        #event-categories-filter {
            display: flex; flex-wrap: wrap; gap: 6px; /* Smaller gap */
            padding: 8px 15px; /* Reduced padding */
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; /* Prevent shrinking */
            overflow-x: auto; /* Allow horizontal scroll if filters overflow */
        }
        .category-filter {
            display: flex; align-items: center; cursor: pointer;
            padding: 3px 7px; border-radius: 15px; /* Smaller padding */
            background-color: #f1f3f4; font-size: 0.75em; /* Smaller text */
            transition: background-color 0.2s, box-shadow 0.2s;
            white-space: nowrap; /* Prevent wrapping within a filter button */
        }
        .category-filter:hover { background-color: #e8eaf0; }
        .category-filter.selected { background-color: var(--secondary-color); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .category-filter.selected .category-dot { border: 1px solid white; }
        .category-filter.selected .category-name { color: white; }
        .category-dot {
            width: 8px; height: 8px; border-radius: 50%; /* Smaller dot */
            margin-right: 5px; flex-shrink: 0;
        }

        /* Event List */
        .event-panel-list {
            flex-grow: 1; /* Takes remaining space in events panel */
            overflow-y: auto;
            padding: 10px 15px; /* Padding for content */
        }
        .event-item {
             padding: 0; /* Remove outer padding, card has padding */
             position: relative;
        }
        .event-item:hover .delete-event { opacity: 1; }

        .event-card {
            background-color: #fff;
            padding: 10px; /* Reduced padding */
            margin-bottom: 8px; /* Reduced margin */
            border-radius: 6px;
            border-left: 4px solid var(--text-muted);
            transition: box-shadow 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .event-card:hover { box-shadow: 0 2px 6px rgba(0,0,0,0.08); }

        .event-content-wrapper { flex-grow: 1; margin-right: 8px; }
        .event-header { display: flex; align-items: center; margin-bottom: 4px; }
        .event-icon { margin-right: 6px; font-size: 1em; }
        .event-name { font-weight: 500; color: var(--text-color); font-size: 0.9em; }
        .event-details { font-size: 0.8em; color: var(--text-muted); display: flex; gap: 8px; flex-wrap: wrap; } /* Allow wrapping */
        .event-time::before { content: "\f017"; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 3px; }
        .event-location::before { content: "\f3c5"; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 3px; }
        .event-description { font-size: 0.75em; margin-top: 4px; color: #555; }

        .delete-event {
            color: #e57373;
            font-size: 1.1em; /* Adjust size */
            font-weight: bold;
            opacity: 0.2;
            transition: opacity 0.2s, color 0.2s;
            flex-shrink: 0;
            padding: 0 4px; /* Click area */
        }
        .delete-event:hover { color: #d32f2f; opacity: 1;}

        .no-events {
            padding: 30px 15px; text-align: center; color: var(--text-muted);
            font-style: normal; font-size: 0.85em;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
         .no-events::before {
             content: "\f11a"; /* Smile */
             font-family: 'Font Awesome 6 Free'; font-weight: 400;
             font-size: 1.8em;
             color: var(--border-color);
         }

        /* --- Desktop / Larger Screens --- */
        @media (min-width: 768px) {
            body { font-size: 17px; } /* Restore larger base */

            .calendar-popup {
                /* Revert to side-by-side layout */
                top: 50%; left: 50%;
                transform: translate(-50%, -50%) scale(0.9); /* Keep initial transform */
                width: 90%;
                max-width: 900px; /* Original Wider */
                height: 85vh;
                max-height: 650px;
                flex-direction: row; /* Side by side */
                border-radius: 15px; /* Restore original radius */
                max-width: 900px;
            }
             .calendar-popup.active {
                 transform: translate(-50%, -50%) scale(1); /* Restore active transform */
             }


            .calendar-main {
                flex-grow: 1;
                flex-shrink: 0; /* Don't shrink main calendar area */
                height: 100%; /* Fill vertical space */
                min-height: auto; /* Remove mobile min-height */
                border-right: 1px solid var(--border-color); /* Add border back */
                border-bottom: none; /* Remove bottom border */
                overflow: visible; /* Allow content visibility */
                border-radius: 15px 0 0 15px; /* Match popup corner */
            }
             .calendar-header { border-radius: 15px 0 0 0; padding: 15px 20px; } /* Restore padding */
             #month-year { font-size: 1.2em; } /* Restore size */
             .nav-button { font-size: 1.4em; } /* Restore size */
             .calendar-config { padding: 8px 20px; font-size: 0.9em; } /* Restore */
             .calendar-weekdays { padding: 8px 5px; } /* Restore */
             .weekday { font-size: 0.8em; } /* Restore */


            .calendar-days {
                 overflow-y: hidden; /* No scroll needed usually */
                 /* Animation classes stay the same */
            }

            .day {
                min-height: 75px; /* Restore height */
                padding: 6px; /* Restore padding */
                font-size: 0.85em; /* Restore size */
            }
             .eng-date { font-size: 1.1em; } /* Restore */
             .nepali-date { font-size: 0.8em; } /* Restore */
             .calendar-days.nepali-visible .nepali-date { font-size: 1.1em; }
             .calendar-days.nepali-visible .eng-date { font-size: 0.8em; }

            /* Event Indicators */
            .event-dot { width: var(--event-dot-size); height: var(--event-dot-size); } /* Restore original size */
             .holiday-dot { width: var(--event-dot-size); height: var(--event-dot-size); }
             .event-count { font-size: 0.7em;}


            /* Events Panel Desktop */
            .events-panel {
                width: 300px; /* Fixed width */
                flex-shrink: 0;
                position: static; /* Remove absolute positioning */
                height: 100%; /* Fill height */
                transform: none; /* Remove mobile transform */
                opacity: 1; /* Panel is always visible if container is */
                visibility: visible;
                border-left: 1px solid var(--border-color); /* Separator */
                box-shadow: none; /* Remove mobile shadow */
                border-radius: 0 15px 15px 0; /* Match popup corner */
            }
             /* Hide mobile-specific visibility class effect */
             .events-panel.mobile-visible { transform: none; }

             /* Restore panel content styles */
             .event-panel-header { padding: 15px 20px; border-radius: 0 15px 0 0; }
             #event-panel-date { font-size: 1.1em; }
             #event-panel-date .sub-date { font-size: 0.8em; }
             .holiday-badge { font-size: 0.75em; padding: 2px 8px; }
             #event-categories-filter { padding: 10px 20px; }
             .category-filter { padding: 4px 8px; font-size: 0.8em; }
             .category-dot { width: 10px; height: 10px; }
             .event-panel-list { padding: 10px 0 10px 0; } /* Adjust as needed */
             .event-item { padding: 0px 10px 0px 15px; }
             .event-card { padding: 12px; margin-bottom: 10px; border-radius: 8px; }
             .event-icon { font-size: 1.1em; }
             .event-name { font-size: 1em; }
             .event-details { font-size: 0.85em; gap: 10px; }
             .event-description { font-size: 0.8em; }
             .delete-event { font-size: 1.2em; }
             .no-events { padding: 40px 20px; font-size: 0.9em; }
             .no-events::before { font-size: 2em; }
             #close-events { display: none !important; } /* Ensure mobile close is hidden */
        }

    </style>
</head>
<body>

    <!-- Calendar Icon Trigger -->
    <div id="calendar-icon-container">
        <button id="calendar-icon" aria-label="Open Calendar">
            <i class="far fa-calendar-alt"></i>
        </button>
    </div>

    <!-- Calendar Popup Structure -->
    <div id="calendar-popup" class="calendar-popup" role="dialog" aria-modal="true" aria-labelledby="calendar-title" aria-hidden="true">

        <!-- Calendar Main Area -->
        <div class="calendar-main">
            <div class="calendar-header">
                <button id="prev-month" class="nav-button" aria-label="Previous Month">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="month-year" aria-live="polite">Month Year</h2>
                <button id="next-month" class="nav-button" aria-label="Next Month">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button id="close-calendar" class="nav-button close-button" aria-label="Close Calendar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="calendar-config">
                <label class="toggle-switch" for="nepali-date-toggle">
                    Show Nepali Dates
                    <input type="checkbox" id="nepali-date-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="calendar-weekdays">
                <div class="weekday">Sun</div>
                <div class="weekday">Mon</div>
                <div class="weekday">Tue</div>
                <div class="weekday">Wed</div>
                <div class="weekday">Thu</div>
                <div class="weekday">Fri</div>
                <div class="weekday">Sat</div>
            </div>
            <div id="calendar-days" class="calendar-days">
                <!-- Days will be generated here -->
            </div>
        </div>

        <!-- Events Side Panel -->
        <aside id="events-panel" class="events-panel" aria-labelledby="event-panel-date">
            <div class="event-panel-header">
                <div id="event-panel-date">Select a date</div>
                <!-- Holiday badge will be inserted here by JS -->
                <!-- Mobile Close Button for this Panel -->
                <button id="close-events" class="nav-button close-button" aria-label="Close Events Panel">
                     <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="event-categories-filter">
                <!-- Category filter options will be generated here -->
            </div>
            <ul id="event-panel-list" class="event-panel-list">
                <li class="no-events">Select a date to see events.</li>
            </ul>
        </aside>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Combined Calendar script loaded.");

            // --- DOM Elements ---
            const calendarIcon = document.getElementById('calendar-icon');
            const calendarPopup = document.getElementById('calendar-popup');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const monthYearDisplay = document.getElementById('month-year');
            const calendarDaysContainer = document.getElementById('calendar-days');
            const nepaliDateToggle = document.getElementById('nepali-date-toggle');
            const eventsPanel = document.getElementById('events-panel');
            const eventPanelDate = document.getElementById('event-panel-date');
            const eventPanelList = document.getElementById('event-panel-list');
            const eventCategoriesFilter = document.getElementById('event-categories-filter');
            const closeCalendarBtn = document.getElementById('close-calendar');
            const closeEventsBtn = document.getElementById('close-events'); // Mobile events panel close

            // --- State ---
            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();
            let showNepaliDates = nepaliDateToggle ? nepaliDateToggle.checked : false;
            let selectedDate = null;
            let selectedCategories = new Set();
            let isMobileView = window.innerWidth < 768; // Track view state

             // --- Data (Keep your existing data structures) ---
             const eventsData = {
                '2024-07-15': [ { id: 1, name: 'Team Lunch', category: 'work', time: '12:30', location: 'Cafeteria', description: 'Team building lunch' } ],
                '2024-07-22': [ { id: 3, name: 'Art Workshop', category: 'culture', time: '10:00', location: 'Art Gallery', description: 'Learn painting techniques' } ],
                '2024-07-05': [ { id: 4, name: 'Summer Sale', category: 'promotion', time: 'All Day', location: 'City Mall', description: 'Up to 50% off' } ],
                '2024-08-01': [
                    { id: 5, name: 'Park Festival', category: 'holiday', time: '09:00', location: 'Central Park', description: 'Music and food stalls' },
                    { id: 6, name: 'Coding Bootcamp', category: 'education', time: '14:00', location: 'Innovation Hub', description: 'Learn JavaScript basics' },
                    { id: 7, name: 'Open Mic Night', category: 'entertainment', time: '20:00', location: 'The Local Pub', description: 'Showcase your talent' }
                ],
                 // Add data matching today/tomorrow for testing
                 [(new Date().toISOString().split('T')[0])] : [ { id: 101, name: 'Daily Standup', category: 'work', time: '09:00', location: 'Office / Zoom', description: 'Quick updates' } ],
                 [(() => { const d = new Date(); d.setDate(d.getDate() + 1); return d.toISOString().split('T')[0]; })()] : [ { id: 102, name: 'Client Meeting Prep', category: 'work', time: '11:00', location: 'Meeting Room 3', description: 'Prepare presentation' } ]
            };

             const holidays = {
                nepali: { '2081-01-01': 'Nepali New Year', '2081-07-03': 'Dashain (Phulpati)', '2081-07-21': 'Tihar (Laxmi Puja)', },
                english: { '2024-01-01': 'New Year\'s Day', '2024-12-25': 'Christmas Day' }
            };

             const categoryConfig = {
                'entertainment': { color: '#ff7f50', icon: '🎵' }, 'education': { color: '#4682b4', icon: '📚' },
                'culture': { color: '#9370db', icon: '🎨' }, 'holiday': { color: '#2e8b57', icon: '🎉' },
                'promotion': { color: '#eec609', icon: '💰' }, 'work': { color: '#0277bd', icon: '💼' },
                'default': { color: '#808080', icon: '📅' }
            };

             const nepaliDaysInMonth = {
                2080: [30, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30], 2081: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 29, 30],
                2082: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2083: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 30],
            };
            const nepaliMonths = [ 'बैशाख', 'जेठ', 'असार', 'श्रावण', 'भदौ', 'असोज', 'कार्तिक', 'मंसिर', 'पुष', 'माघ', 'फागुन', 'चैत' ];
            const nepaliDigits = ['०', '१', '२', '३', '४', '५', '६', '७', '८', '९'];


            // --- Helper Functions (Keep your existing getNepaliDetails, etc.) ---
             function toNepaliDigits(num) { /* ... Keep existing ... */
                 return num.toString().split('').map(d => nepaliDigits[parseInt(d)] || d).join('');
             }
             function getNepaliDetails(targetDate) { /* ... Keep existing ... */
                const year = targetDate.getFullYear();
                const month = targetDate.getMonth(); // 0-indexed
                const day = targetDate.getDate();
                const referenceEnglishDate = new Date(2024, 0, 1);
                const referenceNepaliYear = 2080;
                const referenceNepaliMonth = 8; // Poush (0-indexed)
                const referenceNepaliDay = 16;

                function checkYearData(yr) {
                    if (!nepaliDaysInMonth[yr]) {
                         console.warn(`Nepali month data missing for year ${yr}. Conversion might be inaccurate.`);
                         return nepaliDaysInMonth[2081]; // Fallback
                    }
                    return nepaliDaysInMonth[yr];
                }

                const millisecondsPerDay = 24 * 60 * 60 * 1000;
                const targetUTC = Date.UTC(year, month, day);
                const referenceUTC = Date.UTC(referenceEnglishDate.getFullYear(), referenceEnglishDate.getMonth(), referenceEnglishDate.getDate());
                const daysDifference = Math.round((targetUTC - referenceUTC) / millisecondsPerDay);

                let nepaliYear = referenceNepaliYear;
                let nepaliMonth = referenceNepaliMonth;
                let nepaliDay = referenceNepaliDay;
                let currentYearData = checkYearData(nepaliYear);
                let remainingDays = daysDifference;

                if (remainingDays >= 0) {
                    while (remainingDays > 0) {
                        const daysInCurrentMonth = currentYearData[nepaliMonth];
                        const daysLeftInMonth = daysInCurrentMonth - nepaliDay;
                        if (remainingDays <= daysLeftInMonth) {
                            nepaliDay += remainingDays; remainingDays = 0;
                        } else {
                            remainingDays -= (daysLeftInMonth + 1); nepaliDay = 1; nepaliMonth++;
                            if (nepaliMonth > 11) {
                                nepaliMonth = 0; nepaliYear++; currentYearData = checkYearData(nepaliYear);
                            }
                        }
                    }
                } else {
                    remainingDays = Math.abs(remainingDays);
                    while (remainingDays > 0) {
                        const daysToSubtract = nepaliDay - 1;
                        if (remainingDays <= daysToSubtract) {
                            nepaliDay -= remainingDays; remainingDays = 0;
                        } else {
                             remainingDays -= daysToSubtract + 1; nepaliMonth--;
                             if (nepaliMonth < 0) {
                                 nepaliMonth = 11; nepaliYear--; currentYearData = checkYearData(nepaliYear);
                             }
                             nepaliDay = currentYearData[nepaliMonth];
                        }
                    }
                }
                return { year: nepaliYear, month: nepaliMonth, day: nepaliDay, monthName: nepaliMonths[nepaliMonth], dayNepali: toNepaliDigits(nepaliDay), yearNepali: toNepaliDigits(nepaliYear) };
             }
            function getEventsForDate(date) { /* ... Keep existing ... */
                const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                return eventsData[dateString] || [];
            }
            function isHoliday(date) { /* ... Keep existing ... */
                 const dateKeyEn = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                 if (holidays.english[dateKeyEn]) return true;
                 const nepaliDate = getNepaliDetails(date);
                 const dateKeyNp = `${nepaliDate.year}-${String(nepaliDate.month + 1).padStart(2, '0')}-${String(nepaliDate.day).padStart(2, '0')}`;
                 return !!holidays.nepali[dateKeyNp];
             }
            function getHolidayName(date) { /* ... Keep existing ... */
                const dateKeyEn = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                if (holidays.english[dateKeyEn]) return holidays.english[dateKeyEn];
                const nepaliDate = getNepaliDetails(date);
                const dateKeyNp = `${nepaliDate.year}-${String(nepaliDate.month + 1).padStart(2, '0')}-${String(nepaliDate.day).padStart(2, '0')}`;
                return holidays.nepali[dateKeyNp] || '';
            }

            // --- Calendar Rendering ---
            function renderCalendar(month, year) {
                console.log(`Rendering calendar for: ${year}-${month + 1}`);
                const nepaliHeaderDate = getNepaliDetails(new Date(year, month, 1));
                monthYearDisplay.textContent = `${new Date(year, month).toLocaleString('en-US', { month: 'long' })} ${year} / ${nepaliHeaderDate.monthName} ${nepaliHeaderDate.yearNepali}`;

                const fragment = document.createDocumentFragment();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();
                const today = new Date(); today.setHours(0, 0, 0, 0);

                // Previous month days
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const dayElement = document.createElement('div');
                    dayElement.classList.add('day', 'inactive');
                    const dayNum = daysInPrevMonth - firstDayOfMonth + 1 + i;
                    const prevMonthDate = new Date(year, month - 1, dayNum);
                    const nepDate = getNepaliDetails(prevMonthDate);
                    dayElement.innerHTML = `<div class="day-dates"><span class="eng-date">${dayNum}</span><span class="nepali-date">${nepDate.dayNepali}</span></div>`;
                    fragment.appendChild(dayElement);
                }

                // Current month days
                for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) {
                    const dayElement = document.createElement('div');
                    dayElement.classList.add('day');
                    const currentDate = new Date(year, month, dayNum); currentDate.setHours(0, 0, 0, 0);
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
                    dayElement.dataset.date = dateString;
                    const nepDate = getNepaliDetails(currentDate);

                    dayElement.innerHTML = `<div class="day-dates"><span class="eng-date">${dayNum}</span><span class="nepali-date">${nepDate.dayNepali}</span></div>`;

                    const events = getEventsForDate(currentDate);
                    if (events.length > 0) {
                        const eventIndicator = document.createElement('div');
                        eventIndicator.classList.add('event-indicator');
                        dayElement.classList.add('has-events');
                        const maxDots = isMobileView ? 3 : 4; // Show fewer dots on mobile
                        const uniqueCategories = [...new Set(events.map(e => e.category || 'default'))];

                        uniqueCategories.slice(0, maxDots).forEach(category => {
                            const dot = document.createElement('span');
                            dot.classList.add('event-dot');
                            dot.style.backgroundColor = categoryConfig[category]?.color || categoryConfig.default.color;
                            eventIndicator.appendChild(dot);
                        });
                        if (events.length > maxDots && uniqueCategories.length <= maxDots) { // Show count if dots fit but total events > dots
                            const countBadge = document.createElement('span');
                            countBadge.classList.add('event-count');
                            countBadge.textContent = events.length;
                            eventIndicator.appendChild(countBadge);
                        } else if (uniqueCategories.length > maxDots) { // Show '+' if categories overflow dots
                            const more = document.createElement('span'); more.classList.add('event-count'); more.textContent='+'; eventIndicator.appendChild(more);
                        }

                        dayElement.appendChild(eventIndicator);
                    }

                    if (currentDate.getTime() === today.getTime()) { dayElement.classList.add('today'); }
                    if (selectedDate && currentDate.getTime() === selectedDate.getTime()) { dayElement.classList.add('selected'); }
                    if (isHoliday(currentDate)) {
                        dayElement.classList.add('holiday');
                        dayElement.setAttribute('title', getHolidayName(currentDate));
                    }

                    dayElement.addEventListener('click', () => handleDateClick(dayElement, currentDate));
                    fragment.appendChild(dayElement);
                }

                 // Next month days
                const totalDaysRendered = firstDayOfMonth + daysInMonth;
                const nextMonthDaysToAdd = (7 - (totalDaysRendered % 7)) % 7;
                 for (let i = 1; i <= nextMonthDaysToAdd; i++) {
                     const dayElement = document.createElement('div');
                     dayElement.classList.add('day', 'inactive');
                     const nextMonthDate = new Date(year, month + 1, i);
                     const nepDate = getNepaliDetails(nextMonthDate);
                     dayElement.innerHTML = `<div class="day-dates"><span class="eng-date">${i}</span><span class="nepali-date">${nepDate.dayNepali}</span></div>`;
                     fragment.appendChild(dayElement);
                 }

                // Update DOM smoothly
                calendarDaysContainer.innerHTML = '';
                calendarDaysContainer.appendChild(fragment);
                calendarDaysContainer.classList.toggle('nepali-visible', showNepaliDates);

                // Ensure fade-in animation runs
                calendarDaysContainer.classList.remove('fade-in');
                void calendarDaysContainer.offsetWidth; // Force reflow
                calendarDaysContainer.classList.add('fade-in');
            }

            // --- Event Handling ---
            function handleDateClick(dayElement, date) {
                console.log("Date clicked:", date.toDateString());
                const previouslySelected = calendarDaysContainer.querySelector('.day.selected');
                if (previouslySelected) previouslySelected.classList.remove('selected');
                dayElement.classList.add('selected');
                selectedDate = date;
                updateEventsPanel(date);

                // Show events panel (slide up on mobile)
                if (isMobileView) {
                    eventsPanel.classList.add('mobile-visible');
                } else {
                    eventsPanel.classList.add('active'); // Ensure active for desktop logic if needed
                }
            }

            function updateEventsPanel(date) {
                 const events = getEventsForDate(date);
                 const nepaliDate = getNepaliDetails(date);
                 const holidayName = getHolidayName(date);

                 eventPanelDate.innerHTML = `
                     ${date.toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' })}
                     <span class="sub-date">${nepaliDate.monthName} ${nepaliDate.dayNepali}, ${nepaliDate.yearNepali}</span>
                     ${holidayName ? `<div class="holiday-badge">${holidayName}</div>` : ''}
                 `;

                 eventPanelList.innerHTML = '';
                 if (!eventCategoriesFilter.hasChildNodes()) { // Populate filters only once
                    updateCategoryFilters(eventsData); // Pass all data to get all categories
                 }

                 const filteredEvents = selectedCategories.size > 0
                     ? events.filter(event => selectedCategories.has(event.category || 'default'))
                     : events;

                 if (filteredEvents.length > 0) {
                    filteredEvents.sort((a, b) => (a.time === 'All Day' ? -1 : b.time === 'All Day' ? 1 : (a.time || '').localeCompare(b.time || '')));
                    filteredEvents.forEach(event => {
                        const li = document.createElement('li');
                        li.classList.add('event-item');
                        li.dataset.eventId = event.id;
                        const category = event.category || 'default';
                        const categoryInfo = categoryConfig[category] || categoryConfig.default;

                        li.innerHTML = `
                            <div class="event-card" style="border-left-color: ${categoryInfo.color}">
                                <div class="event-content-wrapper">
                                    <div class="event-header">
                                        <span class="event-icon">${categoryInfo.icon}</span>
                                        <span class="event-name">${event.name}</span>
                                    </div>
                                    <div class="event-details">
                                        ${event.time ? `<span class="event-time">${event.time}</span>` : ''}
                                        ${event.location ? `<span class="event-location">${event.location}</span>` : ''}
                                    </div>
                                     ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                                </div>
                                <button class="delete-event" aria-label="Delete event ${event.name}">×</button>
                            </div>
                        `;
                        li.querySelector('.delete-event').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteEvent(date, event.id);
                        });
                        // li.addEventListener('click', () => console.log("Clicked event card:", event.name));
                        eventPanelList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.classList.add('no-events');
                    li.textContent = selectedCategories.size > 0 ? 'No events match filters.' : 'No events scheduled.';
                    eventPanelList.appendChild(li);
                }
                 // Panel visibility is handled by handleDateClick (mobile) or CSS (desktop)
            }

            function deleteEvent(date, eventId) {
                 const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                 if (eventsData[dateString]) {
                     eventsData[dateString] = eventsData[dateString].filter(event => event.id !== eventId);
                     if (eventsData[dateString].length === 0) { delete eventsData[dateString]; }
                     console.log(`Deleted event ${eventId} on ${dateString}`);
                     updateEventsPanel(date); // Refresh panel
                     renderCalendar(currentMonth, currentYear); // Re-render to update indicators
                 }
            }

            function updateCategoryFilters(allEventsData) { // Take all data to find all possible categories
                 if (!eventCategoriesFilter) return;
                 eventCategoriesFilter.innerHTML = ''; // Clear existing
                 const allCategories = new Set(['all']); // Add 'all' filter implicitly later maybe? For now, just event categories.
                 Object.values(allEventsData).flat().forEach(event => allCategories.add(event.category || 'default'));

                 // Optionally add an 'All' filter
                 const allFilterOption = document.createElement('button');
                 allFilterOption.classList.add('category-filter');
                 allFilterOption.dataset.category = 'all';
                 allFilterOption.innerHTML = `<span class="category-name">All</span>`;
                 if (selectedCategories.size === 0) allFilterOption.classList.add('selected'); // Select 'All' if no specific categories are selected
                 allFilterOption.addEventListener('click', () => {
                     selectedCategories.clear();
                     document.querySelectorAll('#event-categories-filter .category-filter.selected').forEach(el => el.classList.remove('selected'));
                     allFilterOption.classList.add('selected');
                     if (selectedDate) updateEventsPanel(selectedDate);
                 });
                 eventCategoriesFilter.appendChild(allFilterOption);


                 allCategories.forEach(category => {
                     if (category === 'all') return; // Skip 'all' here
                     const categoryInfo = categoryConfig[category] || categoryConfig.default;
                     const filterOption = document.createElement('button');
                     filterOption.classList.add('category-filter');
                     filterOption.dataset.category = category;
                     filterOption.innerHTML = `<span class="category-dot" style="background-color: ${categoryInfo.color}"></span><span class="category-name">${category.charAt(0).toUpperCase() + category.slice(1)}</span>`;

                     if (selectedCategories.has(category)) filterOption.classList.add('selected'); // Mark selected if in the set

                     filterOption.addEventListener('click', () => {
                         filterOption.classList.toggle('selected');
                         if (filterOption.classList.contains('selected')) {
                              selectedCategories.add(category);
                              // Deselect 'All' if a specific category is chosen
                              eventCategoriesFilter.querySelector('[data-category="all"]')?.classList.remove('selected');
                         } else {
                              selectedCategories.delete(category);
                              // If no categories are selected, select 'All'
                              if (selectedCategories.size === 0) {
                                   eventCategoriesFilter.querySelector('[data-category="all"]')?.classList.add('selected');
                              }
                         }
                         if (selectedDate) updateEventsPanel(selectedDate);
                     });
                     eventCategoriesFilter.appendChild(filterOption);
                 });
             }


            function changeMonth(offset) {
                 // Start fade out animation
                 calendarDaysContainer.classList.add('fade-out');

                 // Change month after fade out (adjust timeout to match CSS transition)
                 setTimeout(() => {
                    currentMonth += offset;
                    if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                    else if (currentMonth > 11) { currentMonth = 0; currentYear++; }

                    // Re-render calendar (which includes fade-in animation)
                    renderCalendar(currentMonth, currentYear);

                    // Remove fade-out class after rendering starts
                    calendarDaysContainer.classList.remove('fade-out');

                    // Note: The fade-in is handled by renderCalendar adding the .fade-in class
                 }, 200); // Should match transition duration for opacity
            }

            function toggleCalendarPopup() {
                const isOpening = !calendarPopup.classList.contains('active');
                calendarPopup.classList.toggle('active');
                calendarPopup.setAttribute('aria-hidden', !isOpening);
                if (isOpening) {
                    console.log("Calendar opened");
                    handleResize(); // Ensure layout is correct on open
                    renderCalendar(currentMonth, currentYear);
                    if (selectedDate) { // Re-select date and show panel if one was selected
                        const dateString = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
                        const dayElement = calendarDaysContainer.querySelector(`.day[data-date="${dateString}"]`);
                        if(dayElement) dayElement.classList.add('selected');
                        updateEventsPanel(selectedDate);
                        if(isMobileView) eventsPanel.classList.add('mobile-visible'); // Ensure panel shows on mobile if date selected
                    } else if(isMobileView) {
                         eventsPanel.classList.remove('mobile-visible'); // Hide panel if no date selected on mobile
                    }
                } else {
                    console.log("Calendar closed");
                    if(isMobileView) eventsPanel.classList.remove('mobile-visible'); // Ensure panel is hidden when closing on mobile
                }
            }

            function handleResize() {
                const currentlyMobile = window.innerWidth < 768;
                if (currentlyMobile !== isMobileView) { // Only update if breakpoint crossed
                    isMobileView = currentlyMobile;
                    calendarPopup.classList.toggle('mobile-view', isMobileView);
                    console.log("View changed. isMobileView:", isMobileView);

                    // If switching TO desktop, ensure mobile panel isn't stuck visible
                    if (!isMobileView) {
                        eventsPanel.classList.remove('mobile-visible');
                    }
                    // If switching TO mobile and a date is selected, ensure panel becomes visible
                    else if (selectedDate && calendarPopup.classList.contains('active')) {
                         eventsPanel.classList.add('mobile-visible');
                    }

                    // Re-render calendar might be needed if indicators/layout change significantly
                     if (calendarPopup.classList.contains('active')) {
                         renderCalendar(currentMonth, currentYear);
                         if (selectedDate) { // Re-apply selection visually after re-render
                             const dateString = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
                            const dayElement = calendarDaysContainer.querySelector(`.day[data-date="${dateString}"]`);
                             if(dayElement) dayElement.classList.add('selected');
                         }
                    }
                }
            }

            // --- Event Listeners ---
            calendarIcon?.addEventListener('click', toggleCalendarPopup);
            prevMonthBtn?.addEventListener('click', () => changeMonth(-1));
            nextMonthBtn?.addEventListener('click', () => changeMonth(1));
            closeCalendarBtn?.addEventListener('click', toggleCalendarPopup);

            nepaliDateToggle?.addEventListener('change', (event) => {
                showNepaliDates = event.target.checked;
                console.log("Show Nepali Dates:", showNepaliDates);
                if (calendarPopup.classList.contains('active')) renderCalendar(currentMonth, currentYear); // Re-render only if visible
            });

            // Close Events Panel on Mobile
            closeEventsBtn?.addEventListener('click', () => {
                eventsPanel.classList.remove('mobile-visible');
            });

            // Close popup when clicking outside
            document.addEventListener('click', (event) => {
                if (calendarPopup?.classList.contains('active') && !calendarPopup.contains(event.target) && !calendarIcon?.contains(event.target)) {
                    toggleCalendarPopup();
                }
            });

            // Keyboard navigation (Simplified - focus handling can be complex)
             calendarDaysContainer?.addEventListener('keydown', (event) => {
                 if (!selectedDate) return;
                 const key = event.key;
                 if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) return;

                 event.preventDefault();
                 let targetDate = new Date(selectedDate);

                 if (key === 'ArrowLeft') targetDate.setDate(targetDate.getDate() - 1);
                 else if (key === 'ArrowRight') targetDate.setDate(targetDate.getDate() + 1);
                 else if (key === 'ArrowUp') targetDate.setDate(targetDate.getDate() - 7);
                 else if (key === 'ArrowDown') targetDate.setDate(targetDate.getDate() + 7);

                 // Check if the target date is visible in the current grid
                 const dateString = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
                 const dayElement = calendarDaysContainer.querySelector(`.day[data-date="${dateString}"]:not(.inactive)`);

                 if (dayElement) {
                     handleDateClick(dayElement, targetDate); // Select the new date
                      // Optionally try to focus, but managing focus robustly can be tricky
                     // dayElement.focus();
                 } else if (targetDate.getMonth() !== currentMonth || targetDate.getFullYear() !== currentYear) {
                     // If date is outside current month, change month
                     changeMonth(targetDate > selectedDate ? 1 : -1);
                     // Ideally, you'd want to select the targetDate *after* the new month renders.
                     // This requires a callback or promise mechanism in changeMonth/renderCalendar.
                     // For simplicity now, just change the month. User needs to navigate again.
                     selectedDate = targetDate; // Update logical selection
                 }
                 // If target date is inactive (prev/next month shown), don't select
             });


            window.addEventListener('resize', handleResize);

            // --- Initial Setup ---
            showNepaliDates = nepaliDateToggle?.checked || false;
            handleResize(); // Set initial view state (mobile/desktop)
            updateCategoryFilters(eventsData); // Populate filters based on *all* data initially

            // Optionally select today and show events only if the popup starts open,
            // otherwise, render happens on first open.
            // renderCalendar(currentMonth, currentYear); // Render initially if needed even when hidden
            // const today = new Date();
            // const todayString = ...; etc. - selection logic moved to toggleCalendarPopup's opening sequence


            console.log("Combined calendar initialized.");

        }); // End DOMContentLoaded
    </script>

</body>
</html>